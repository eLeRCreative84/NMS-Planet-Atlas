<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; overflow: hidden; }
  #form { flex: 0 0 25%; min-width: 280px; max-width: 450px; padding: 1rem; background: #0a1e3a; color: white; overflow-y: auto; box-sizing: border-box; }
  #globeViz { flex: 1; background: black; }
  h2 { margin-top: 1rem; margin-bottom: 0.5rem; }
  input, select, textarea, button { width: 100%; margin: 0.3rem 0; padding: 0.4rem; box-sizing: border-box; }
  button { cursor: pointer; }
  .texture-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .texture-input button { flex: 1; padding: 0.5rem; border: none; background: #1976d2; color: white; border-radius: 4px; }
  .texture-input button:hover { background: #1565c0; }
  ul { padding: 0; list-style: none; }
  li { margin: 0.3rem 0; background: #1a2b4d; padding: 0.3rem; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  li div { display: flex; gap: 0.5rem; align-items: center; }
  li button { padding: 0.2rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; }
  li button.edit { background: #0277bd; color: white; }
  li button.del { background: #c62828; color: white; }
  label { display: block; margin-top: 0.5rem; font-weight: bold; }
</style>
</head>
<body>
<div id="form">
  <h2>Dodaj punkt</h2>
  <label>Planeta</label><input type="text" id="planet" placeholder="Nazwa planety" />
  <label>X</label><input type="number" id="lat" step="0.0001" />
  <label>Y</label><input type="number" id="lng" step="0.0001" />
  <label>Nazwa punktu</label><input type="text" id="name" />
  <label>Typ</label>
  <select id="type">
    <option>Zas贸b</option>
    <option>Obelisk</option>
    <option>Baza</option>
    <option>Ruiny</option>
    <option>Du偶a struktura</option>
    <option>Inne</option>
  </select>
  <label>Notatki</label><textarea id="notes"></textarea>
  <button onclick="addPoint()">Dodaj punkt</button>

  <h2>Planety</h2>
  <div id="planetList"></div>

  <h2>Punkty na planecie</h2>
  <label>Sortuj:</label>
  <select id="sortPoints" onchange="refreshPointsList()">
    <option value="nameAsc">Nazwa AZ</option>
    <option value="nameDesc">Nazwa ZA</option>
    <option value="type">Typ</option>
    <option value="newest">Najnowsze</option>
    <option value="oldest">Najstarsze</option>
  </select>
  <ul id="pointsList"></ul>

  <h2>Tekstura planety</h2>
  <div class="texture-input">
    <input type="file" id="planetTextureInput" accept="image/*" hidden />
    <button onclick="document.getElementById('planetTextureInput').click()">Wybierz plik</button>
    <button onclick="setPlanetTextureFromInput()">Ustaw</button>
  </div>

  <h2>Skalowanie</h2>
  <label>Oddal glob</label>
  <input type="range" id="globeScale" min="0.01" max="1" step="0.01" value="1" oninput="updateGlobeScale()" />
  
  <label>Skala punkt贸w</label>
  <input type="range" id="pointScale" min="0.1" max="5" step="0.1" value="1" oninput="updatePointScale()" />

  <label>Przesu glob</label>
<input type="range" id="globeOffset" min="-500" max="500" step="1" value="0" oninput="updateGlobeOffset()" />

  <button onclick="resetGlobePosition()">Reset pozycji globu</button>

  <h2>Import/Eksport</h2>
  <button onclick="exportAtlas()">Eksport JSON</button>
  <input type="file" id="importFile" accept="application/json" onchange="importAtlas(event)" />
</div>

<div id="globeViz"></div>

<script>
let atlas = JSON.parse(localStorage.getItem("atlas") || "{}");
let planetTextures = JSON.parse(localStorage.getItem("planetTextures") || "{}");
let currentPlanet = null;
let pointScale = 1;

const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null)
  .backgroundImageUrl("//unpkg.com/three-globe/example/img/night-sky.png")
  .pointLat("lat")
  .pointLng("lng")
  .pointLabel(d => {
    let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
    if(d.type==="Zas贸b") label += d.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
    if(d.type==="Obelisk") label += d.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
    return label;
  })
  .pointColor(d=>{
    switch(d.type){
      case "Zas贸b": return d.extracted?"gray":"gold";
      case "Obelisk": return d.visited?"green":"orange";
      case "Baza": return "blue";
      case "Ruiny": return "brown";
      case "Du偶a struktura": return "purple";
      case "Inne": return "pink";
      case "Pole": return "red";
      default: return "red";
    }
  })
  .customLayerData(() => atlas[currentPlanet] || [])
  .customThreeObject(d => {
    if(d.type === "Pole") return null;
    const geom = new THREE.CylinderGeometry(0.05, 0.05, 1, 8);
    const mat = new THREE.MeshBasicMaterial({ color: getPointColor(d) });
    const mesh = new THREE.Mesh(geom, mat);
    mesh.userData = d;
    return mesh;
  })
.customThreeObjectUpdate((obj, d) => {
  const h = (d.height || 0.4) * pointScale;  //  uwzgldniamy height i pointScale
  obj.scale.set(1, h, 1);
  obj.position.set(0, h / 2, 0); // 偶eby supek sta na powierzchni globu
});

  .htmlElementsData([])
  .htmlElement(d => {
    if(d.type==="Pole"){
      const el=document.createElement("div");
      el.style.color="white";
      el.style.fontSize="20px";
      el.style.fontWeight="bold";
      el.style.textShadow="0 0 4px black";
      el.textContent=d.name==="Biegun P贸nocny"?"N":"S";
      return el;
    }
  });

globe.showGraticules(true).graticuleLineWidth(0.5);

function getPointColor(d){
  switch(d.type){
    case "Zas贸b": return d.extracted?"gray":"gold";
    case "Obelisk": return d.visited?"green":"orange";
    case "Baza": return "blue";
    case "Ruiny": return "brown";
    case "Du偶a struktura": return "purple";
    case "Inne": return "pink";
    case "Pole": return "red";
    default: return "red";
  }
}
  
function saveAtlas(){
  localStorage.setItem("atlas", JSON.stringify(atlas));
  localStorage.setItem("planetTextures", JSON.stringify(planetTextures));
}

function addPoles(planet){
  if(!atlas[planet]) atlas[planet]=[];
  if(!atlas[planet].some(p=>p.type==="Pole")){
    atlas[planet].push({lat:90,lng:0,name:"Biegun P贸nocny",type:"Pole"});
    atlas[planet].push({lat:-90,lng:0,name:"Biegun Poudniowy",type:"Pole"});
  }
}

function refreshPlanetList(){
  const list = document.getElementById("planetList");
  list.innerHTML="";
  Object.keys(atlas).forEach(p=>{
    const btn = document.createElement("button");
    btn.textContent=p;
    btn.style.width="100%";
    btn.style.margin="0.2rem 0";
    btn.onclick=()=>{
      currentPlanet=p;
      document.getElementById("planet").value=p; 
      addPoles(p);
      globe.pointsData(atlas[p]);
      globe.htmlElementsData(atlas[p].filter(pt=>pt.type==="Pole"));
      setPlanetTexture(p);
      refreshPointsList();
    };
    list.appendChild(btn);
  });
}

function refreshPointsList(){
  const list=document.getElementById("pointsList");
  list.innerHTML="";
  if(!currentPlanet || !atlas[currentPlanet]) return;

  let points=[...atlas[currentPlanet]];
  const sort=document.getElementById("sortPoints").value;
  if(sort==="nameAsc") points.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  if(sort==="nameDesc") points.sort((a,b)=>(b.name||"").localeCompare(a.name||""));
  if(sort==="type") points.sort((a,b)=>(a.type||"").localeCompare(b.type||""));
  if(sort==="newest") points.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
  if(sort==="oldest") points.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));

  points.forEach((point,index)=>{
    const li=document.createElement("li");
    li.style.display = "flex";
    li.style.flexDirection = "column";   //  ustawia elementy w kolumnie
    li.style.alignItems = "flex-start";  //  wyr贸wnuje do lewej

    // opis punktu
    const info=document.createElement("span");
    info.innerHTML=`${point.name || "Bez nazwy"} (${point.type})<br>X:${point.lat}, Y:${point.lng}`;
    li.appendChild(info);

    // przyciski i checkbox
    const btnDiv=document.createElement("div");
    btnDiv.style.display="flex";
    btnDiv.style.gap="0.5rem";
    if(point.type==="Zas贸b" || point.type==="Obelisk"){
      const checkbox=document.createElement("input");
      checkbox.type="checkbox";
      checkbox.checked=point.type==="Zas贸b"?point.extracted:point.visited;
      checkbox.onchange=()=>{
        if(point.type==="Zas贸b") point.extracted=checkbox.checked;
        if(point.type==="Obelisk") point.visited=checkbox.checked;
        saveAtlas();
        globe.pointsData(atlas[currentPlanet]);
        refreshPointsList();
      };
      btnDiv.appendChild(checkbox);
    }

    const editBtn=document.createElement("button");
    editBtn.textContent="Edytuj"; editBtn.className="edit";
    editBtn.onclick=()=>editPoint(index);
    btnDiv.appendChild(editBtn);

    const delBtn=document.createElement("button");
    delBtn.textContent="Usu"; delBtn.className="del";
    delBtn.onclick=()=>{
      if(confirm("Czy na pewno usun punkt?")){
        atlas[currentPlanet].splice(index,1);
        saveAtlas();
        refreshPointsList();
        globe.pointsData(atlas[currentPlanet]);
      }
    };
    btnDiv.appendChild(delBtn);

    li.appendChild(btnDiv);

    //  suwak wysokoci zawsze pod spodem 
    const heightSlider = document.createElement("input");
    heightSlider.type = "range";
    heightSlider.min = 0.1;
    heightSlider.max = 5;
    heightSlider.step = 0.1;
    heightSlider.value = point.height || 0.4;
    heightSlider.style.width = "100%";
    heightSlider.style.marginTop = "0.5rem"; // odstp od przycisk贸w
heightSlider.oninput = () => {
  point.height = parseFloat(heightSlider.value);
  saveAtlas();
  if(currentPlanet) globe.pointsData(atlas[currentPlanet]); //  odwie偶a wszystkie supki
};

    li.appendChild(heightSlider);
    // 

    list.appendChild(li);
  });
}

function addPoint(){
  const planet = document.getElementById("planet").value.trim();
  const lat = parseFloat(document.getElementById("lat").value);
  const lng = parseFloat(document.getElementById("lng").value);
  const name = document.getElementById("name").value.trim();
  const type = document.getElementById("type").value;
  const notes = document.getElementById("notes").value.trim();
  if(!planet || isNaN(lat) || isNaN(lng)){ alert("Uzupenij planet i wsp贸rzdne!"); return; }
  if(!atlas[planet]) atlas[planet]=[];
  const point={planet,lat,lng,name,type,notes,timestamp:Date.now()};
  if(type==="Zas贸b") point.extracted=false;
  if(type==="Obelisk") point.visited=false;
  atlas[planet].push(point);
  saveAtlas();
  currentPlanet=planet;
  refreshPlanetList();
  globe.pointsData(atlas[planet]);
  refreshPointsList();
}

function editPoint(index){
  if(!currentPlanet || !atlas[currentPlanet]) return;
  const p=atlas[currentPlanet][index];
  document.getElementById("planet").value=currentPlanet;
  document.getElementById("lat").value=p.lat;
  document.getElementById("lng").value=p.lng;
  document.getElementById("name").value=p.name;
  document.getElementById("type").value=p.type;
  document.getElementById("notes").value=p.notes;
  atlas[currentPlanet].splice(index,1);
  saveAtlas();
  refreshPointsList();
  globe.pointsData(atlas[currentPlanet]);
}

function setPlanetTexture(planet){
  if(planetTextures[planet]) globe.globeImageUrl(planetTextures[planet]);
  else globe.globeImageUrl(null);
}

function setPlanetTextureFromInput(){
  const input=document.getElementById("planetTextureInput");
  if(!input.files[0]||!currentPlanet) return;
  const reader=new FileReader();
  reader.onload=e=>{
    planetTextures[currentPlanet]=e.target.result;
    setPlanetTexture(currentPlanet);
    saveAtlas();
  };
  reader.readAsDataURL(input.files[0]);
}

function exportAtlas(){
  const blob=new Blob([JSON.stringify({atlas,planetTextures},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.atlas) atlas=data.atlas;
      if(data.planetTextures) planetTextures=data.planetTextures;
      saveAtlas();
      refreshPlanetList();
      alert("Import zakoczony!");
    }catch(err){alert("Bd importu JSON");}
  };
  reader.readAsText(file);
}

// Skalowanie globu
function updateGlobeScale(){
  const scale=parseFloat(document.getElementById("globeScale").value);
  globe.scene().scale.set(scale,scale,scale);
}

// Skalowanie punkt贸w
function updatePointScale(){
  pointScale = parseFloat(document.getElementById("pointScale").value);
  if(currentPlanet) {
    globe.pointsData(atlas[currentPlanet]); //  powoduje ponowne wywoanie customThreeObjectUpdate
  }
}


// Przesuwanie globu w lewo/prawo
function updateGlobeOffset(){
  const offset = parseFloat(document.getElementById("globeOffset").value);
  globe.scene().position.x = offset;
}

  // reset suwkow
function resetGlobePosition() {
  document.getElementById("globeOffset").value = 0;
  globe.scene().position.x = 0;

  // jeli dodasz te偶 o Y/Z, to mo偶esz je tu wyzerowa
  // document.getElementById("globeOffsetY").value = 0;
  // globe.scene().position.y = 0;
}

  
refreshPlanetList();
</script>
</body>
</html>
