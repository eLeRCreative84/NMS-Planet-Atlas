<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; overflow: hidden; font-size: 14px; }
  #form { flex: 0 0 25%; min-width: 280px; max-width: 450px; padding: 1rem; background: #0a1e3a; color: white; overflow-y: auto; box-sizing: border-box; }
  #globeViz { flex: 1; background: black; position: relative; }
  /* upewniamy siƒô ≈ºe canvas zajmuje ca≈Çy obszar kontenera */
  #globeViz canvas { width: 100% !important; height: 100% !important; display: block; background: transparent; }

  h2 { margin-top: 1rem; margin-bottom: 0.5rem; }
  input, select, textarea, button { width: 100%; margin: 0.3rem 0; padding: 0.4rem; box-sizing: border-box; }
  button { cursor: pointer; }
  .texture-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .texture-input button { flex: 1; padding: 0.5rem; border: none; background: #1976d2; color: white; border-radius: 4px; }
  .texture-input button:hover { background: #1565c0; }
  ul { padding: 0; list-style: none; }
  li { margin: 0.3rem 0; background: #1a2b4d; padding: 0.3rem; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  li div { display: flex; gap: 0.5rem; align-items: center; }
  li button { padding: 0.2rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; }
  li button.edit { background: #0277bd; color: white; }
  li button.del { background: #c62828; color: white; }
  label { display: block; margin-top: 0.5rem; font-weight: bold; }
  .xy-inputs { display: flex; gap: 0.3rem; }
  .xy-inputs input { width: 50%; }

  #tabs { display: flex; background: #102b56; margin-bottom: 0.5rem; }
  #tabs button { flex: 1; padding: 0.5rem; border: none; background: #102b56; color: white; cursor: pointer; font-weight: bold; }
  #tabs button.active { background: #1976d2; }
  .tab-content { display: none; padding: 1rem 0 0 0; overflow-y: auto; }
  .tab-content.active { display: block; }
 
#filterPoints {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
}
#filterPoints label {
  display: flex;
  align-items: center;
  background: #1a2b4d;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
}
#filterPoints input {
  margin-right: 0.3rem;
}
  
</style>
</head>
<body>
<div id="form">
  <div id="tabs">
    <button class="active" onclick="openTab('start')">Start</button>
    <button onclick="openTab('planety')">Planety</button>
    <button onclick="openTab('punkty')">Punkty</button>
    <button onclick="openTab('detale')">Detale planety</button>
  </div>

  <!-- Zak≈Çadka START -->
  <div id="start" class="tab-content active">
    <h2>Dodaj punkt</h2>
    <label>Planeta</label>
    <input type="text" id="planet" placeholder="Nazwa planety" />
    <div class="xy-inputs">
      <div><label>X</label><input type="number" id="lat" step="0.0001" /></div>
      <div><label>Y</label><input type="number" id="lng" step="0.0001" /></div>
    </div>
    <label>Nazwa punktu</label>
    <input type="text" id="name" />
    <label>Typ</label>
    <select id="type">
      <option>Zas√≥b</option>
      <option>Obelisk</option>
      <option>Baza</option>
      <option>Ruiny</option>
      <option>Du≈ºa struktura</option>
      <option>Inne</option>
    </select>
    <label>Notatki</label>
    <textarea id="notes"></textarea>

    <!-- UWAGA: element wymagany przez skrypt (by uniknƒÖƒá b≈Çƒôd√≥w JS) -->
    <label>Notatka planety</label>
    <textarea id="planetNote"></textarea>

    <button onclick="addPoint()">Dodaj punkt</button>

    <h2>Tekstura planety</h2>
    <div class="texture-input">
      <input type="file" id="planetTextureInput" accept="image/*" hidden />
      <button onclick="document.getElementById('planetTextureInput').click()">Wybierz plik</button>
      <button onclick="setPlanetTextureFromInput()">Ustaw</button>
    </div>

    <h2>Skalowanie i pozycja globu</h2>
    <label>Skala punkt√≥w</label>
    <input type="range" id="pointScale" min="0.1" max="5" step="0.1" value="0.4" oninput="updatePointScale()" />
    <label>Oddal glob</label>
    <input type="range" id="globeScale" min="0.01" max="1" step="0.01" value="1" oninput="updateGlobeScale()" />
    <label>Przesu≈Ñ glob</label>
    <input type="range" id="globeOffset" min="-500" max="500" step="1" value="0" oninput="updateGlobeOffset()" />
    <button onclick="resetGlobePosition()">Reset pozycji globu</button>

    <h2>Import/Eksport</h2>
    <button onclick="exportAtlas()">Eksport JSON</button>
    <input type="file" id="importFile" accept="application/json" onchange="importAtlas(event)" />
  </div>

  <!-- Zak≈Çadka PLANETY -->
  <div id="planety" class="tab-content">
    <h2>Planety</h2>
    <div id="planetList"></div>
  </div>

  <!-- Zak≈Çadka PUNKTY -->
  <div id="punkty" class="tab-content">
    <h2>Punkty na planecie</h2>

     <!-- Filtruj -->
<div id="filterPoints" style="margin-bottom:0.5rem;">
  <label><input type="checkbox" value="Zas√≥b" checked onchange="applyPointFilter()"> Zas√≥b</label>
  <label><input type="checkbox" value="Obelisk" checked onchange="applyPointFilter()"> Obelisk</label>
  <label><input type="checkbox" value="Baza" checked onchange="applyPointFilter()"> Baza</label>
  <label><input type="checkbox" value="Ruiny" checked onchange="applyPointFilter()"> Ruiny</label>
  <label><input type="checkbox" value="Du≈ºa struktura" checked onchange="applyPointFilter()"> Du≈ºa struktura</label>
  <label><input type="checkbox" value="Inne" checked onchange="applyPointFilter()"> Inne</label>
</div>

    <ul id="pointsList"></ul>
  </div>

  <!-- Zak≈Çadka DETALE PLANETY -->
<div id="detale" class="tab-content">
  <h2>Detale planety</h2>
  <label>Galaktyka</label><input type="text" id="detailGalaxy" />
  <label>Region</label><input type="text" id="detailRegion" />
  <label>Uk≈Çad gwiazdowy</label><input type="text" id="detailSystem" />

  <label>Biom</label>
  <select id="detailBiome">
    <option value="">-- wybierz --</option>
    <option>Bujna</option>
    <option>Ja≈Çowa</option>
    <option>Martwa</option>
    <option>Egzotyczna</option>
    <option>Mega Egzotyczna</option>
    <option>Spalona</option>
    <option>Zamro≈ºona</option>
    <option>Toksyczna</option>
    <option>Napromieniowana</option>
    <option>Bagno</option>
    <option>Wulkaniczna</option>
    <option>Gazowy Gigant</option>
  </select>

  <label>Pogoda</label><input type="text" id="detailWeather" />

  <label>Stra≈ºnicy</label>
  <select id="detailSentinels">
    <option value="">-- wybierz --</option>
    <option>Pasywne</option>
    <option>Brak</option>
    <option>Zrelaksowane</option>
    <option>Ograniczone</option>
    <option>Niskie</option>
    <option>Niskie bezpiecze≈Ñstwo</option>
    <option>Minimalne</option>
    <option>Aktywne</option>
    <option>≈örednie</option>
    <option>Standardowe</option>
    <option>Typowe</option>
    <option>Uwa≈ºne</option>
  </select>

  <label>Flora</label>
  <select id="detailFlora">
    <option value="">-- wybierz --</option>
    <option>Brak</option>
    <option>Sporadyczna</option>
    <option>SkƒÖpa</option>
    <option>≈örednia</option>
    <option>Obfita</option>
    <option>Ekstremalna</option>
  </select>

  <label>Fauna</label>
  <select id="detailFauna">
    <option value="">-- wybierz --</option>
    <option>Brak</option>
    <option>Sporadyczna</option>
    <option>SkƒÖpa</option>
    <option>≈örednia</option>
    <option>Obfita</option>
    <option>Ekstremalna</option>
  </select>

  <label>Roszczenie przez</label><input type="text" id="detailClaimed" />
  <label>Odkryty przez</label><input type="text" id="detailDiscovered" />

  <label>Tryb gry</label>
  <select id="detailMode">
    <option value="">-- wybierz --</option>
    <option>Normalny</option>
    <option>Kreatywny</option>
    <option>Survival</option>
    <option>Permadeath</option>
  </select>

  <label>Zaktualizowano</label><input type="text" id="detailUpdated" />
  <label>Koordynaty</label><input type="text" id="detailCoords" />
  <!-- Przycisk przejd≈∫ do NMS Portals -->
<button onclick="window.open('https://nmsportals.github.io', '_blank')" 
        style="margin-top:0.5rem; background:#1976d2; color:white; padding:0.5rem; border:none; border-radius:4px; cursor:pointer;">
  Przejd≈∫ do NMS Portals
</button>

  
  <label>Notatki planety</label><textarea id="detailNotes"></textarea>
  <button onclick="savePlanetDetails()">Zapisz opis planety</button>
</div>
</div>

<div id="globeViz"></div>

<script>
let atlas = JSON.parse(localStorage.getItem("atlas") || "{}");
let planetTextures = JSON.parse(localStorage.getItem("planetTextures") || "{}");
let planetNotes = JSON.parse(localStorage.getItem("planetNotes") || "{}");
let planetDetails = JSON.parse(localStorage.getItem("planetDetails") || "{}"); // dla detali planety, je≈õli u≈ºywasz
let currentPlanet = null;
let pointScale = parseFloat(document.getElementById("pointScale").value);

// Inicjalizacja globu ‚Äî u≈ºywamy https aby t≈Ço zawsze siƒô za≈Çadowa≈Ço
const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null) // brak domy≈õlnej mapy (pusta/ciemna kula)
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png') // üåå gwiazdy w tle
  .pointLat("lat")
  .pointLng("lng")
  .pointLabel(d => {
    // zabezpieczenie: gdy nie ma currentPlanet, zwracamy opis punktu pojedynczo
    if (!currentPlanet || !atlas[currentPlanet]) {
      let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
      if (d.type === "Zas√≥b") label += d.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
      if (d.type === "Obelisk") label += d.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
      return label;
    }

    // grupowanie punkt√≥w w tym samym miejscu dla aktualnej planety
    const sameLocation = atlas[currentPlanet].filter(p => p.lat === d.lat && p.lng === d.lng);
    if (sameLocation.length > 1) {
      return sameLocation.map(p => {
        let label = `${p.name || "Bez nazwy"} (${p.type})`;
        if (p.type === "Zas√≥b") label += p.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
        if (p.type === "Obelisk") label += p.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
        return label;
      }).join("<br>");
    }

    let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
    if (d.type === "Zas√≥b") label += d.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
    if (d.type === "Obelisk") label += d.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
    return label;
  })
  .pointColor(d=>{
    switch(d.type){
      case "Zas√≥b": return d.extracted?"gray":"gold";
      case "Obelisk": return d.visited?"green":"orange";
      case "Baza": return "blue";
      case "Ruiny": return "brown";
      case "Du≈ºa struktura": return "purple";
      case "Inne": return "pink";
      case "Pole": return "red";
      default: return "red";
    }
  })
  .pointRadius(() => pointScale)
  .htmlElementsData([])
  .htmlElement(d=>{
    if(d.type==="Pole"){
      const el=document.createElement("div");
      el.style.color="white";
      el.style.fontSize="20px";
      el.style.fontWeight="bold";
      el.style.textShadow="0 0 4px black";
      el.textContent=d.name==="Biegun P√≥≈Çnocny"?"N":"S";
      return el;
    }
  });

globe.showGraticules(true).graticuleLineWidth(0.5);

// ---------------------- TABY ----------------------
function openTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll("#tabs button").forEach(el => el.classList.remove("active"));
  const tab = document.getElementById(tabId);
  if(tab) tab.classList.add("active");
  // oznacz odpowiedni przycisk jako active (przybli≈ºone dopasowanie)
  document.querySelectorAll("#tabs button").forEach(btn=>{
    if (btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(`'${tabId}'`)) btn.classList.add("active");
  });
}

// ---------------------- FUNKCJE ZAPIS/Od≈õwie≈º ----------------------
function saveAtlas(){
  localStorage.setItem("atlas", JSON.stringify(atlas));
  localStorage.setItem("planetTextures", JSON.stringify(planetTextures));
  localStorage.setItem("planetNotes", JSON.stringify(planetNotes));
  localStorage.setItem("planetDetails", JSON.stringify(planetDetails));
}

function addPoles(planet){
  if(!atlas[planet]) atlas[planet] = [];
  if(!atlas[planet].some(p => p.type==="Pole")){
    atlas[planet].push({lat:90,lng:0,name:"Biegun P√≥≈Çnocny",type:"Pole"});
    atlas[planet].push({lat:-90,lng:0,name:"Biegun Po≈Çudniowy",type:"Pole"});
  }
}

function refreshPlanetList(){
  const list = document.getElementById("planetList");
  list.innerHTML = "";
  Object.keys(atlas).forEach(p => {
    const btn = document.createElement("button");
    btn.textContent = p;
    btn.style.width = "100%";
    btn.style.margin = "0.2rem 0";
    btn.onclick = () => {
      currentPlanet = p;
      document.getElementById("planet").value = p;
      // je≈õli mamy planetNote w storage, ustawiamy pole (pole istnieje)
      if (document.getElementById("planetNote")) document.getElementById("planetNote").value = planetNotes[p] || "";
      addPoles(p);
      refreshGlobePoints();
      globe.htmlElementsData(atlas[p].filter(pt => pt.type==="Pole"));
      setPlanetTexture(p);
      applyPointFilter();
    };
    list.appendChild(btn);
  });
}

function addPoint(){
  const planet = document.getElementById("planet").value.trim();
  const lat = parseFloat(document.getElementById("lat").value);
  const lng = parseFloat(document.getElementById("lng").value);
  const name = document.getElementById("name").value.trim();
  const type = document.getElementById("type").value;
  const notes = document.getElementById("notes").value.trim();
  // zapis notatki planety do planetNotes (pole istnieje w DOM)
  planetNotes[planet] = document.getElementById("planetNote") ? document.getElementById("planetNote").value.trim() : (planetNotes[planet] || "");
  if(!planet || isNaN(lat) || isNaN(lng)){
    alert("Uzupe≈Çnij planetƒô i wsp√≥≈Çrzƒôdne!");
    return;
  }
  if(!atlas[planet]) atlas[planet] = [];
  const point = {planet, lat, lng, name, type, notes, timestamp: Date.now()};
  if(type==="Zas√≥b") point.extracted=false;
  if(type==="Obelisk") point.visited=false;
  atlas[planet].push(point);
  saveAtlas();
  currentPlanet = planet;
  refreshPlanetList();   // od≈õwie≈ºa listƒô planet w zak≈Çadce Planety
  applyPointFilter()   // od≈õwie≈ºa listƒô punkt√≥w w zak≈Çadce Punkty (i filtr dzia≈Ça poprawnie)
  refreshGlobePoints();  // aktualizuje punkty na globie
}

function editPoint(index){
  if(!currentPlanet || !atlas[currentPlanet]) return;
  const p = atlas[currentPlanet][index];
  document.getElementById("planet").value = currentPlanet;
  document.getElementById("lat").value = p.lat;
  document.getElementById("lng").value = p.lng;
  document.getElementById("name").value = p.name;
  document.getElementById("type").value = p.type;
  document.getElementById("notes").value = p.notes;
  atlas[currentPlanet].splice(index,1);
  saveAtlas();
  applyPointFilter()
  refreshGlobePoints();
}

function setPlanetTexture(planet){
  if(planetTextures[planet]) globe.globeImageUrl(planetTextures[planet]);
  else globe.globeImageUrl(null);
}

function setPlanetTextureFromInput(){
  const input = document.getElementById("planetTextureInput");
  if(!input.files[0] || !currentPlanet) return;
  const reader = new FileReader();
  reader.onload = e => {
    planetTextures[currentPlanet] = e.target.result;
    setPlanetTexture(currentPlanet);
    saveAtlas();
  };
  reader.readAsDataURL(input.files[0]);
}

function exportAtlas(){
  const blob = new Blob([JSON.stringify({atlas,planetTextures,planetNotes,planetDetails},null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      if(data.atlas) atlas = data.atlas;
      if(data.planetTextures) planetTextures = data.planetTextures;
      if(data.planetNotes) planetNotes = data.planetNotes;
      if(data.planetDetails) planetDetails = data.planetDetails;
      saveAtlas();
      refreshPlanetList();
      alert("Import zako≈Ñczony!");
    } catch(err){ alert("B≈ÇƒÖd importu JSON"); }
  };
  reader.readAsText(file);
}

// Skalowanie globu
function updateGlobeScale(){
  const scale = parseFloat(document.getElementById("globeScale").value);
  globe.scene().scale.set(scale, scale, scale);
}

// Skalowanie punkt√≥w
function updatePointScale(){
  pointScale = parseFloat(document.getElementById("pointScale").value);
  refreshGlobePoints();
}

// Przesuwanie globu w lewo/prawo
function updateGlobeOffset(){
  const offset = parseFloat(document.getElementById("globeOffset").value);
  globe.scene().position.x = offset;
}

function resetGlobePosition(){
  document.getElementById("globeOffset").value = 0;
  globe.scene().position.x = 0;
  // reset suwaka oddalenia globu
  document.getElementById("globeScale").value = 1;
  globe.scene().scale.set(1,1,1);
}

// Detale planety 
function loadPlanetDetails(){
  if(!currentPlanet) return;
  const details=planetDetails[currentPlanet]||{};
  document.getElementById("detailGalaxy").value=details.galaxy||"";
  document.getElementById("detailRegion").value=details.region||"";
  document.getElementById("detailSystem").value=details.system||"";
  document.getElementById("detailBiome").value=details.biome||"";
  document.getElementById("detailWeather").value=details.weather||"";
  document.getElementById("detailSentinels").value=details.sentinels||"";
  document.getElementById("detailFlora").value=details.flora||"";
  document.getElementById("detailFauna").value=details.fauna||"";
  document.getElementById("detailClaimed").value=details.claimed||"";
  document.getElementById("detailDiscovered").value=details.discovered||"";
  document.getElementById("detailMode").value=details.mode||"";
  document.getElementById("detailUpdated").value=details.updated||"";
  document.getElementById("detailCoords").value=details.coords||"";
  document.getElementById("detailNotes").value=details.notes||"";
}
function savePlanetDetails(){
  if(!currentPlanet) return;
  planetDetails[currentPlanet]={
    galaxy:document.getElementById("detailGalaxy").value,
    region:document.getElementById("detailRegion").value,
    system:document.getElementById("detailSystem").value,
    biome:document.getElementById("detailBiome").value,
    weather:document.getElementById("detailWeather").value,
    sentinels:document.getElementById("detailSentinels").value,
    flora:document.getElementById("detailFlora").value,
    fauna:document.getElementById("detailFauna").value,
    claimed:document.getElementById("detailClaimed").value,
    discovered:document.getElementById("detailDiscovered").value,
    mode:document.getElementById("detailMode").value,
    updated:document.getElementById("detailUpdated").value,
    coords:document.getElementById("detailCoords").value,
    notes:document.getElementById("detailNotes").value
  };
  saveAtlas();
  alert("Opis zapisany!");
}

// Od≈õwie≈ºenie punkt√≥w na globie
function refreshGlobePoints(){
  if(!currentPlanet) return;
  globe.pointsData(atlas[currentPlanet]);
}

  // Filtrowanie punkt√≥w
function applyPointFilter() {
  if (!currentPlanet || !atlas[currentPlanet]) return;

  // Typy zaznaczone w filtrze
  const checkedTypes = Array.from(document.querySelectorAll('#filterPoints input:checked'))
                            .map(cb => cb.value);

  // Filtrujemy punkty (bieguny zawsze widoczne na globie)
  const visiblePoints = atlas[currentPlanet].filter(p => p.type === "Pole" || checkedTypes.includes(p.type));

  // ------------------- Glob -------------------
  globe.pointsData(visiblePoints);
  globe.pointColor(d => {
    if (d.type === "Pole") return "red"; // bieguny zawsze widoczne
    if (!checkedTypes.includes(d.type)) return "rgba(0,0,0,0)"; // ukryj punkt wizualnie
    switch (d.type) {
      case "Zas√≥b": return d.extracted ? "gray" : "gold";
      case "Obelisk": return d.visited ? "green" : "orange";
      case "Baza": return "blue";
      case "Ruiny": return "brown";
      case "Du≈ºa struktura": return "purple";
      case "Inne": return "pink";
      default: return "red";
    }
  });

  // ------------------- Lista HUD -------------------
  const list = document.getElementById("pointsList");
  list.innerHTML = "";

  visiblePoints.forEach(point => {
    if (point.type === "Pole") return; // pomijamy bieguny w li≈õcie

    const li = document.createElement("li");

    // Pobieramy **prawdziwy indeks punktu w atlas[currentPlanet]**
    const idx = atlas[currentPlanet].indexOf(point);
    li.dataset.index = idx;

    // Tekst nazwy
    const span = document.createElement("span");
    span.textContent = `${point.name || "Bez nazwy"} (${point.type})`;
    li.appendChild(span);

    // Przycisk Edytuj
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edytuj";
    editBtn.className = "edit";
    editBtn.onclick = () => editPoint(idx);
    li.appendChild(editBtn);

    // Przycisk Usu≈Ñ
    const delBtn = document.createElement("button");
    delBtn.textContent = "Usu≈Ñ";
    delBtn.className = "del";
    delBtn.onclick = () => {
      if (confirm("Czy na pewno usunƒÖƒá punkt?")) {
        atlas[currentPlanet].splice(idx, 1);
        saveAtlas();
        applyPointFilter(); // od≈õwie≈º listƒô i glob
      }
    };
    li.appendChild(delBtn);

    // Checkbox Zas√≥b/Obelisk
    if (point.type === "Zas√≥b" || point.type === "Obelisk") {
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = point.type === "Zas√≥b" ? point.extracted : point.visited;
      checkbox.onchange = () => {
        if (point.type === "Zas√≥b") atlas[currentPlanet][idx].extracted = checkbox.checked;
        if (point.type === "Obelisk") atlas[currentPlanet][idx].visited = checkbox.checked;
        saveAtlas();
        applyPointFilter();
      };
      li.appendChild(checkbox);
    }

    list.appendChild(li);
  });
}



  
// start
refreshPlanetList();
</script>
</body>
</html>
