<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Atlas Planetarny</title>
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
      overflow: hidden;
      font-size: 14px;
    }

    #form {
      flex: 0 0 25%;
      min-width: 280px;
      max-width: 450px;
      padding: 1rem;
      background: #0a1e3a;
      color: white;
      overflow-y: auto;
      box-sizing: border-box;
    }

    #globeViz {
      flex: 1;
      background: black;
      position: relative;
    }

    /* upewniamy się że canvas zajmuje cały obszar kontenera */
    #globeViz canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      background: transparent;
    }

    h2 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }

    input,
    select,
    textarea,
    button {
      width: 100%;
      margin: 0.3rem 0;
      padding: 0.4rem;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
    }

    .texture-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .texture-input button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      background: #1976d2;
      color: white;
      border-radius: 4px;
    }

    .texture-input button:hover {
      background: #1565c0;
    }

    .texture-input {
      display: flex;
      gap: 0.5rem;
      margin: 0.3rem 0;
    }

    .texture-input input[type="file"],
    .texture-input input[type="color"] {
      flex: 1;
      /* obie zajmują równą szerokość */
      max-width: 200px;
      /* ograniczenie szerokości */
    }

    .texture-input button {
      flex: 1;
      max-width: 200px;
    }

    ul {
      padding: 0;
      list-style: none;
    }

    li {
      margin: 0.3rem 0;
      background: #1a2b4d;
      padding: 0.3rem;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    li div {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    li button {
      padding: 0.2rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    li button.edit {
      background: #0277bd;
      color: white;
    }

    li button.del {
      background: #c62828;
      color: white;
    }

    label {
      display: block;
      margin-top: 0.5rem;
      font-weight: bold;
    }

    .xy-inputs {
      display: flex;
      gap: 0.3rem;
    }

    .xy-inputs input {
      width: 50%;
    }

    #tabs {
      display: flex;
      background: #102b56;
      margin-bottom: 0.5rem;
    }

    #tabs button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      background: #102b56;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    #tabs button.active {
      background: #1976d2;
    }

    .tab-content {
      display: none;
      padding: 1rem 0 0 0;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    /* Nagłówek aktualnej planety */
    .currentPlanetHeader {
      margin: 0.2rem 0 0.5rem 0;
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
      background-color: #1a3a6a;
      /* jasny granat, pasuje do zakładek */
      padding: 0.3rem 0;
      border-radius: 4px;
      color: white;
    }

    /* Pola współrzędnych X i Y */
    .xy-inputs {
      display: flex;
      gap: 1cm;
      /* większy odstęp między polami */
    }

    .xy-inputs div {
      display: flex;
      flex-direction: column;
      width: max-content;
      /* szerokość dopasowana do napisu */
    }

    .xy-inputs input {
      width: 100%;
      /* dopasowuje się do szerokości rodzica */
    }

    .tab-content h2 {
      text-align: center;
    }
  </style>
</head>
<body>

    <div id="form">
    <div id="tabs">
      <button class="active" data-tab="planets">Planety</button>
      <button data-tab="points">Punkty</button>
      <button data-tab="labels">Etykiety</button>
      <button data-tab="orbits">Orbity</button>
    </div>

    <!-- Zakładka: Planety -->
    <div id="planets" class="tab-content active">
      <h2>Planety</h2>
      <form id="planetForm">
        <label>Nazwa</label>
        <input id="planetName" placeholder="np. Mars" required />

        <label>Kolor / Tekstura</label>
        <div class="texture-input">
          <input type="file" id="planetTexture" accept="image/*" />
          <input type="color" id="planetColor" value="#888888" />
        </div>

        <label>Rozmiar (km)</label>
        <input id="planetSize" type="number" value="6371" />

        <label>Odległość od centrum (AU)</label>
        <input id="planetDistance" type="number" value="1" />

        <label>Prędkość obrotu (deg/s)</label>
        <input id="planetRotationSpeed" type="number" value="0.1" step="0.01" />

        <button type="submit">Dodaj planetę</button>
      </form>
      <ul id="planetList"></ul>
    </div>

    <!-- Zakładka: Punkty -->
    <div id="points" class="tab-content">
      <h2>Punkty</h2>
      <div class="currentPlanetHeader">Brak wybranej planety</div>
      <form id="pointForm">
        <label>Nazwa</label>
        <input id="pointName" placeholder="np. Krater Gale" required />

        <label>Współrzędne (X, Y)</label>
        <div class="xy-inputs">
          <div>
            <span>X:</span>
            <input id="pointX" type="number" step="0.01" />
          </div>
          <div>
            <span>Y:</span>
            <input id="pointY" type="number" step="0.01" />
          </div>
        </div>

        <label>Opis</label>
        <textarea id="pointDesc"></textarea>

        <button type="submit">Dodaj punkt</button>
      </form>
      <ul id="pointList"></ul>
    </div>

    <!-- Zakładka: Etykiety -->
    <div id="labels" class="tab-content">
      <h2>Etykiety</h2>
      <div class="currentPlanetHeader">Brak wybranej planety</div>
      <form id="labelForm">
        <label>Treść etykiety</label>
        <input id="labelText" required />

        <label>Pozycja (X, Y)</label>
        <div class="xy-inputs">
          <div>
            <span>X:</span>
            <input id="labelX" type="number" step="0.01" />
          </div>
          <div>
            <span>Y:</span>
            <input id="labelY" type="number" step="0.01" />
          </div>
        </div>

        <button type="submit">Dodaj etykietę</button>
      </form>
      <ul id="labelList"></ul>
    </div>

    <!-- Zakładka: Orbity -->
    <div id="orbits" class="tab-content">
      <h2>Orbity</h2>
      <form id="orbitForm">
        <label>Obiekt centralny</label>
        <select id="orbitCenter"></select>

        <label>Obiekt orbitujący</label>
        <select id="orbitTarget"></select>

        <label>Promień orbity (AU)</label>
        <input id="orbitRadius" type="number" value="1" step="0.1" />

        <label>Prędkość orbitalna (deg/s)</label>
        <input id="orbitSpeed" type="number" value="0.1" step="0.01" />

        <button type="submit">Dodaj orbitę</button>
      </form>
      <ul id="orbitList"></ul>
    </div>
  </div>

  <div id="globeViz"></div>

  <script>
let planets = []; // główna tablica wszystkich planet
let currentPlanet = null;
let pointScale = parseFloat(document.getElementById("pointScale").value);
let editIndex = null;

////////////////////////////////////////////////////////////////////
//----------------- Zakładki i inne elementy UI -----------------//
////////////////////////////////////////////////////////////////////

function openTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll("#tabs button").forEach(el => el.classList.remove("active"));
  const tab = document.getElementById(tabId);
  if(tab) tab.classList.add("active");
  document.querySelectorAll("#tabs button").forEach(btn=>{
    if (btn.getAttribute("onclick")?.includes('${tabId}')) btn.classList.add("active");
  });
}

function updateCurrentPlanetHeader() {
  document.querySelectorAll(".currentPlanetHeader").forEach(h => {
    h.textContent = currentPlanet ? currentPlanet.name : "Brak wybranej planety";
  });
}

function updateNoPlanetsMessage() {
  const msg = document.getElementById("noPlanetsMessage");
  msg.style.display = planets.length === 0 ? "block" : "none";
}

////////////////////////////////////////////////////////////////////
//------------------ Detale planety ------------------------------//
////////////////////////////////////////////////////////////////////

function loadPlanetDetails(){
  if(!currentPlanet) return;
  const details=currentPlanet.details;
  document.getElementById("detailGalaxy").value=details.galaxy||"";
  document.getElementById("detailRegion").value=details.region||"";
  document.getElementById("detailSystem").value=details.system||"";
  document.getElementById("detailBiome").value=details.biome||"";
  document.getElementById("detailWeather").value=details.weather||"";
  document.getElementById("detailSentinels").value=details.sentinels||"";
  document.getElementById("detailFlora").value=details.flora||"";
  document.getElementById("detailFauna").value=details.fauna||"";
  document.getElementById("detailDiscovered").value=details.discovered||"";
  document.getElementById("detailMode").value=details.mode||"";
  document.getElementById("detailUpdated").value=details.updated||"";
  document.getElementById("detailCoords").value=details.coords||"";
  document.getElementById("detailNotes").value=details.notes||"";
}

function savePlanetDetails(){
  if(!currentPlanet) return;
  currentPlanet.details = {
    galaxy:document.getElementById("detailGalaxy").value,
    region:document.getElementById("detailRegion").value,
    system:document.getElementById("detailSystem").value,
    biome:document.getElementById("detailBiome").value,
    weather:document.getElementById("detailWeather").value,
    sentinels:document.getElementById("detailSentinels").value,
    flora:document.getElementById("detailFlora").value,
    fauna:document.getElementById("detailFauna").value,
    discovered:document.getElementById("detailDiscovered").value,
    mode:document.getElementById("detailMode").value,
    updated:document.getElementById("detailUpdated").value,
    coords:document.getElementById("detailCoords").value,
    notes:document.getElementById("detailNotes").value
  };
  alert("Opis zapisany!");
}

////////////////////////////////////////////////////////////////////
//------------------ Planety, lista, tworzenie -------------------//
////////////////////////////////////////////////////////////////////

function checkNewPlanetInput() {
  const input = document.getElementById("newPlanetName");
  document.getElementById("addPlanetBtn").disabled = input.value.trim() === "";
}

function addNewPlanet() {
  const input = document.getElementById("newPlanetName");
  const name = input.value.trim();
  if (!name) return;
  if (planets.some(p=>p.name===name)) {
    alert("Planeta już istnieje!");
    return;
  }
  const newPlanet = {
    name,
    points: [],
    texture: null,
    color: null,
    details: { galaxy:"",region:"",system:"",biome:"",weather:"", sentinels:"",flora:"",fauna:"",discovered:"", mode:"",updated:"",coords:"",notes:"" }
  };
  addPoles(newPlanet);
  planets.push(newPlanet);
  currentPlanet = newPlanet;
  updateCurrentPlanetHeader();
  applyPlanetTexture(currentPlanet);
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();
  input.value = "";
  checkNewPlanetInput();
  alert(Dodano nową planetę: ${name});
  updateNoPlanetsMessage();
}

function refreshPlanetList(){
  const list = document.getElementById("planetList");
  list.innerHTML = "";
  planets.forEach(p => {
    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.alignItems = "center";
    container.style.margin = "0.2rem 0";
    const btn = document.createElement("button");
    btn.textContent = p.name;
    btn.style.flex = "1";
    btn.style.marginRight = "0.5rem";
    btn.style.background = "#e5e5e5";
    btn.style.color = "black";
    btn.style.border = "none";
    btn.style.padding = "0.3rem";
    btn.style.borderRadius = "4px";
    btn.style.cursor = "pointer";
    btn.onclick = () => {
      currentPlanet = p;
      addPoles(p);
      refreshGlobePoints();
      globe.htmlElementsData(p.points.filter(pt => pt.type==="Pole"));
      applyPlanetTexture(p);
      refreshPointsList();
      loadPlanetDetails();
      updateCurrentPlanetHeader();
    };
    const delBtn = document.createElement("button");
    delBtn.textContent = "Usuń";
    delBtn.style.background = "#c62828";
    delBtn.style.color = "white";
    delBtn.style.border = "none";
    delBtn.style.padding = "0.2rem 0.5rem";
    delBtn.style.borderRadius = "4px";
    delBtn.style.cursor = "pointer";
    delBtn.onclick = e => {
      e.stopPropagation();
      if(confirm(Na pewno usunąć planetę "${p.name}"?)){
        planets = planets.filter(pl=>pl!==p);
        currentPlanet = planets[0] || null;
        if (currentPlanet) {
          applyPlanetTexture(currentPlanet);
          refreshGlobePoints();
        } else {
          globe.globeImageUrl(null);
          globe.pointsData([]);
        }
        updateCurrentPlanetHeader();
        refreshPlanetList();
        refreshPointsList();
      }
    };
    container.appendChild(btn);
    container.appendChild(delBtn);
    list.appendChild(container);
  });
  updateNoPlanetsMessage();
}

////////////////////////////////////////////////////////////////////
//------------------- Punkty, lista, tworzenie -------------------//
////////////////////////////////////////////////////////////////////

function refreshPointsList(){
  const list = document.getElementById("pointsList");
  list.innerHTML = "";
  if(!currentPlanet) return;
  let points = currentPlanet.points.filter(p => p.type !== "Pole");
  const sort = document.getElementById("sortPoints").value;
  if(sort==="nameAsc") points.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  if(sort==="nameDesc") points.sort((a,b)=> (b.name||"").localeCompare(a.name||""));
  if(sort==="type") points.sort((a,b)=> (a.type||"").localeCompare(b.type||""));
  if(sort==="newest") points.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
  if(sort==="oldest") points.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));
  points.forEach((point,index)=>{
    const li = document.createElement("li");
    li.innerHTML = ${point.name||"Bez nazwy"} (${point.type}) X:${point.lat}, Y:${point.lng};
    list.appendChild(li);
  });
}

function addPoint(){
  if (!currentPlanet) {
    alert("Najpierw wybierz planetę!");
    return;
  }
  const lat = parseFloat(document.getElementById("lat").value);
  const lng = parseFloat(document.getElementById("lng").value);
  const name = document.getElementById("name").value.trim();
  const type = document.getElementById("type").value;
  const notes = document.getElementById("notes").value.trim();
  if (isNaN(lat) || isNaN(lng)) {
    alert("Podaj współrzędne!");
    return;
  }
  const point = {lat,lng,name,type,notes,timestamp:Date.now()};
  if(type==="Zasób") point.extracted=false;
  if(type==="Obelisk") point.visited=false;
  currentPlanet.points.push(point);
  refreshPlanetList();
  refreshGlobePoints();
  refreshPointsList();
}

function addPoles(planet){
  if(!planet.points.some(p=>p.type==="Pole")){
    planet.points.push({lat:90,lng:0,name:"Biegun Północny",type:"Pole"});
    planet.points.push({lat:-90,lng:0,name:"Biegun Południowy",type:"Pole"});
  }
}

////////////////////////////////////////////////////////////////////
//---------------- Tekstury i kolory -----------------------------//
////////////////////////////////////////////////////////////////////

function setPlanetColor() {
  if (!currentPlanet) return;
  currentPlanet.color = document.getElementById("planetColorInput").value;
  currentPlanet.texture = null;
  globe.globeImageUrl(null);
  const mat = globe.globeMaterial();
  mat.map = null;
  mat.color.set(currentPlanet.color || "#000000");
  mat.needsUpdate = true;
}

function setPlanetTextureFromInput() {
  if (!currentPlanet) return;
  if (currentPlanet.color) {
    alert("Najpierw usuń kolor planety, zanim nałożysz teksturę!");
    return;
  }
  const input = document.getElementById("planetTextureInput");
  if (!input.files[0]) return;
  const file = input.files[0];
  currentPlanet.texture = file.name;
  currentPlanet.color = null;
  const url = https://elercreative84.github.io/NMS-Planet-Atlas/textures/${currentPlanet.texture};
  console.log("Ustawiam teksturę (globeImageUrl):", url);
  globe.globeImageUrl(url);
  const mat = globe.globeMaterial();
  mat.color.set("#ffffff");
  mat.needsUpdate = true;
}

function removePlanetTexture() {
  if (!currentPlanet) return;
  delete currentPlanet.texture;
  globe.globeImageUrl(null);
  const mat = globe.globeMaterial();
  mat.map = null;
  mat.color.set(currentPlanet.color || "#000000");
  mat.needsUpdate = true;
}

function removePlanetColor() {
  if (!currentPlanet) return;
  delete currentPlanet.color;
  if(!currentPlanet.texture){
    globe.globeImageUrl(null);
    const mat = globe.globeMaterial();
    mat.map = null;
    mat.color.set("#000000");
    mat.needsUpdate = true;
  }
}

function applyPlanetTexture(planet) {
  if (!planet) return;
  if (planet.texture) {
    const url = https://elercreative84.github.io/NMS-Planet-Atlas/textures/${planet.texture};
    console.log("applyPlanetTexture -> używam globeImageUrl:", url);
    globe.globeImageUrl(url);
    const mat = globe.globeMaterial();
    mat.color.set("#ffffff");
    mat.needsUpdate = true;
    return;
  }
  globe.globeImageUrl(null);
  const mat = globe.globeMaterial();
  mat.map = null;
  if (planet.color) {
    mat.color.set(planet.color);
  } else {
    mat.color.set("#000000");
  }
  mat.needsUpdate = true;
}

////////////////////////////////////////////////////////////////////
//---------------- Eksport / Import -------------------------------//
////////////////////////////////////////////////////////////////////

function exportAtlas(){
  const blob = new Blob([JSON.stringify({planets},null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      if(data.planets) planets = data.planets;
      currentPlanet = planets[0] || null;
      if(currentPlanet) applyPlanetTexture(currentPlanet);
      refreshPlanetList();
      refreshPointsList();
      refreshGlobePoints();
      updateCurrentPlanetHeader();
      alert("Import zakończony!");
    }catch(err){alert("Błąd importu JSON");}
  };
  reader.readAsText(file);
}

////////////////////////////////////////////////////////////////////
//---------------- Skalowanie / przesuwanie ----------------------//
////////////////////////////////////////////////////////////////////

function updateGlobeScale(){
  const scale = parseFloat(document.getElementById("globeScale").value);
  globe.scene().scale.set(scale, scale, scale);
}

function updatePointScale(){
  pointScale = parseFloat(document.getElementById("pointScale").value);
  refreshGlobePoints();
}

function updateGlobeOffset(){
  globe.scene().position.x = parseFloat(document.getElementById("globeOffset").value);
}

function resetGlobePosition(){
  document.getElementById("globeOffset").value = 0;
  globe.scene().position.x = 0;
  document.getElementById("globeScale").value = 1;
  globe.scene().scale.set(1,1,1);
}

function refreshGlobePoints(){
  if(!currentPlanet) return;
  globe.pointsData(currentPlanet.points);
}

////////////////////////////////////////////////////////////////////
//---------------- Inicjalizacja globu ---------------------------//
////////////////////////////////////////////////////////////////////

const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null)
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
  .pointLat("lat").pointLng("lng")
  .pointLabel(d => ${d.name||""} (${d.type}))
  .pointColor(d=>{
    switch(d.type){
      case "Zasób": return d.extracted?"gray":"gold";
      case "Obelisk": return d.visited?"green":"orange";
      case "Baza": return "blue";
      case "Ruiny": return "brown";
      case "Struktura": return "purple";
      case "Inne": return "pink";
      case "Pole": return "red";
      default: return "red";
    }
  })
  .pointRadius(()=>pointScale);

globe.showGraticules(true).graticuleLineWidth(0.5);

window.onload = () => {
  openTab("start");
  refreshPlanetList();
  refreshPointsList();
  updateNoPlanetsMessage();
};
</script>
</body>
</html>
