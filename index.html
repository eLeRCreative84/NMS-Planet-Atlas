<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; overflow: hidden; font-size: 14px; }
  #form { flex: 0 0 25%; min-width: 280px; max-width: 450px; padding: 1rem; background: #0a1e3a; color: white; overflow-y: auto; box-sizing: border-box; }
  #globeViz { flex: 1; background: black; position: relative; }
  /* upewniamy siÄ™ Å¼e canvas zajmuje caÅ‚y obszar kontenera */
  #globeViz canvas { width: 100% !important; height: 100% !important; display: block; background: transparent; }

  h2 { margin-top: 1rem; margin-bottom: 0.5rem; }
  input, select, textarea, button { width: 100%; margin: 0.3rem 0; padding: 0.4rem; box-sizing: border-box; }
  button { cursor: pointer; }

  ul { padding: 0; list-style: none; }
  li { margin: 0.3rem 0; background: #1a2b4d; padding: 0.3rem; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  li div { display: flex; gap: 0.5rem; align-items: center; }
  li button { padding: 0.2rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; }
  li button.edit { background: #0277bd; color: white; }
  li button.del { background: #c62828; color: white; }
  label { display: block; margin-top: 0.5rem; font-weight: bold; }
  .xy-inputs { display: flex; gap: 0.3rem; }
  .xy-inputs input { width: 50%; }

  #tabs { display: flex; background: #102b56; margin-bottom: 0.5rem; }
  #tabs button { flex: 1; padding: 0.5rem; border: none; background: #102b56; color: white; cursor: pointer; font-weight: bold; }
  #tabs button.active { background: #1976d2; }
  .tab-content { display: none; padding: 1rem 0 0 0; overflow-y: auto; }
  .tab-content.active { display: block; }

/* NagÅ‚Ã³wek aktualnej planety */
.currentPlanetHeader {
  margin: 0.2rem 0 0.5rem 0;
  font-size: 1.2rem;
  font-weight: bold;
  text-align: center;
  background-color: #1a3a6a; /* jasny granat, pasuje do zakÅ‚adek */
  padding: 0.3rem 0;
  border-radius: 4px;
  color: white;
}

/* Pola wspÃ³Å‚rzÄ™dnych X i Y */
.xy-inputs {
  display: flex;
  gap: 1cm; /* wiÄ™kszy odstÄ™p miÄ™dzy polami */
}
.xy-inputs div {
  display: flex;
  flex-direction: column;
  width: max-content; /* szerokoÅ›Ä‡ dopasowana do napisu */
}

.xy-inputs input {
  width: 100%; /* dopasowuje siÄ™ do szerokoÅ›ci rodzica */
}

.tab-content h2 {
  text-align: center;
}
  
/* Ustawienia wizualizacji globu */
#globeWrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;           /* flexbox */
  justify-content: center; /* poziome centrowanie */
  align-items: center;     /* pionowe centrowanie */
  overflow: hidden;        /* Å¼eby nic nie wystawaÅ‚o */
}

#globeViz {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

#globeViz canvas {
  display: block;
  margin: 0 auto;
}

  /* NagÅ‚Ã³wek nad wizualizacjÄ… planety */
#planetOverlayHeader {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(26, 58, 106, 0.85);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 1.4rem;
  font-weight: bold;
  text-align: center;
  pointer-events: none;
  z-index: 10; 
}
  
/* Ustaw kolor i wybÃ³r palety razem */
.color-picker-row {
 gap: 0.5rem;
}

.color-picker-row label {
  flex: 1;   /* napis zajmuje poÅ‚owÄ™ lub wiÄ™cej w razie potrzeby */
}

.color-picker-row input[type="color"] {
  flex: 1;   /* input zajmuje tyle samo co label dla symetrii */
  height: 2.2rem;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}

/* Ustaw przycisk Tekstury i Koloru razem */
.planet-buttons-row {
  display: flex;
  gap: 0.5rem; /* odstÄ™p miÄ™dzy przyciskami */
}

.planet-buttons-row button {
  flex: 1;             /* rÃ³wnomierna szerokoÅ›Ä‡ */
  padding: 0.5rem;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

#setTextureBtn { background: #1976d2; color: white; }
#setColorBtn   { background: #0288d1; color: white; }

/* Ustaw przycisk StwÃ³rz planetÄ™ i paletÄ™ kolorÃ³w w tym samym rzÄ™dzie oraz opisz przycisk palety */
.planet-action-row {
  display: flex;
  gap: 0.5rem;
  align-items: stretch;
}

/* wspÃ³lne ustawienia obu przyciskÃ³w */
.color-picker-btn, #addPlanetBtn {
  flex: 1;
  height: 3rem;             /* niÅ¼szy, spÃ³jny wyglÄ…d */
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;              /* odstÄ™p miÄ™dzy napisem a pickerem */
  padding: 0 0.5rem;
  box-sizing: border-box;
}

.color-picker-btn {
  background: #0288d1;
  color: white;
 }

.color-picker-btn label {
  margin: 0;
  line-height: 1;
}

.color-picker-btn input[type="color"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  border: none;
  background: none;
  width: 2rem;    /* sam kwadrat pickera */
  height: 2rem;
  padding: 0;
  cursor: pointer;
}

#addPlanetBtn {
  background: #1976d2;
  color: white;
}
/* Wymusza wyrÃ³wnanie przyciskÃ³w "Wybierz kolor z pikerem" i "StwÃ³rz nowÄ… planetÄ™". */
.planet-action-row { display: flex; gap: .5rem; align-items: center; }
.planet-action-row > * { display: inline-flex; align-items: center; justify-content: center; padding: 0 .5rem; box-sizing: border-box; width: auto !important; }
.color-picker-btn label { margin: 0; line-height: 1; display: inline-block; }
.color-picker-btn input[type="color"] { width: 2rem; height: 2rem; padding: 0; margin: 0; vertical-align: middle; display: inline-block; box-sizing: border-box; }
#addPlanetBtn { margin: 0; padding: 0 .5rem; vertical-align: middle; }

</style>
</head>
<body>
<div id="form">
  <div id="tabs">
    <button class="active" onclick="openTab('start')">Start</button>
    <button onclick="openTab('planety')">Planety</button>
    <button onclick="openTab('punkty')">Punkty</button>
    <button onclick="openTab('detale')">Detale planety</button>
  </div>

  <!-- ZakÅ‚adka START -->
  <div id="start" class="tab-content active">
   
    <div id="noPlanetsMessage" style="color: #ffcc00; font-weight: bold; text-align: center; margin: 0.5rem 0;">
  StwÃ³rz nowÄ… planetÄ™ lub importuj dane JSON
</div>

      <h2>Dodaj punkt</h2>
      <div class="xy-inputs">
  <div>
    <label>X (âˆ’90 do 90)</label>
    <input type="number" id="lat" step="1" min="-90" max="90" />
  </div>
  <div>
    <label>Y (âˆ’180 do 180)</label>
    <input type="number" id="lng" step="1" min="-180" max="180" />
  </div>
</div>

    <label>Nazwa punktu</label>
    <input type="text" id="name" />
    <label>Typ</label>
    <select id="type">
      <option>ZasÃ³b</option>
      <option>Baza</option>
      <option>Ruiny</option>
      <option>Struktura</option>
      <option>Inne</option>
    </select>
    <label>Notatki</label>
    <textarea id="notes"></textarea>

    <button onclick="addPoint()">Dodaj punkt</button>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
    <h2>Skalowanie globu i punktÃ³w</h2>

<!-- Suwak 1: Skalowanie punktÃ³w -->
<label>Skalowanie punktÃ³w</label>
<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
  <input type="range" id="pointScale" min="0.1" max="1" step="0.1" value="0.4" oninput="updatePointScale()" style="flex:1;" />
  <span id="pointScaleValue" style="width:2rem; text-align:center;">0.4</span>
  <button onclick="resetPointScale()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
</div>

<!-- Suwak 2: WysokoÅ›Ä‡ sÅ‚upka -->
<label>WysokoÅ›Ä‡ sÅ‚upka</label>
<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
  <input type="range" id="pointsDistanceMultiplier" min="0.5" max="30" step="0.5" value="1" oninput="updatePointsDistanceMultiplier()" style="flex:1;" />
  <span id="pointsDistanceMultiplierValue" style="width:2rem; text-align:center;">1</span>
  <button onclick="resetPointsDistanceMultiplier()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
</div>

<!-- Suwak 3: Zoom globu -->
<label>Zoom globu</label>
<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
  <input type="range" id="globeZoomMultiplier" min="0.5" max="2" step="0.05" value="1" oninput="updateGlobeZoomMultiplier()" style="flex:1;" />
  <span id="globeZoomMultiplierValue" style="width:2rem; text-align:center;">1</span>
  <button onclick="resetGlobeZoomMultiplier()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
</div>

    <!-- AutoobrÃ³t -->
<div style="display:flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
  <span>WÅ‚Ä…cz automatyczne obracanie globu</span>
  <input type="checkbox" id="autoRotateCheckbox" onchange="toggleAutoRotate()" />
</div>
    
   <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
   
    <h2>Import/Eksport</h2>
    <button onclick="exportAtlas()">Eksport JSON</button>
    <input type="file" id="importFile" accept="application/json" onchange="importAtlas(event)" />
  </div>

  <!-- ZakÅ‚adka PLANETY -->
  <div id="planety" class="tab-content">
   
    <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
        <input type="text" id="newPlanetName" placeholder="Nazwa nowej planety" oninput="checkNewPlanetInput()" />
 <!-- Przycisk Dodaj planetÄ™ i wybierz kolor planety z palety Hex -->
  <div class="planet-action-row">
 <div class="color-picker-btn">
  <label for="PlanetColor">Wybierz kolor</label>
  <input type="color" id="PlanetColor" value="#000000">
</div>

  <button id="addPlanetBtn" onclick="addNewPlanet()" disabled>Dodaj nowÄ… planetÄ™</button>
</div>
   </div>

    <!-- Przycisk dodaj texturÄ™ -->
<div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
  <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
  <input type="text" id="planetTextureUrl" placeholder="URL tekstury" oninput="checkTextureInput()" />

  <div class="planet-buttons-row">
    <button id="setTextureBtn" onclick="addTextureUrl()">Ustaw teksturÄ™</button>
    <button id="setColorBtn" onclick="changePlanetColor()">Ustaw kolor</button>

  </div>
</div>
    
    <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>

<div class="planet-buttons-row" style="margin-bottom:1rem;">
  <button id="editSelectedPlanetBtn" onclick="editSelectedPlanet()" disabled>Edytuj zaznaczonÄ…</button>
  <button id="deleteSelectedPlanetBtn" onclick="deleteSelectedPlanet()" disabled>UsuÅ„ zaznaczonÄ…</button>
</div>

<!-- Ukryty kontener na edycjÄ™ -->
<div id="editPlanetBox" style="display:none; margin-bottom:1rem;">
  <input type="text" id="editPlanetName" placeholder="Nowa nazwa planety" style="width:70%; margin-right:0.5rem;">
  <button onclick="acceptEditPlanet()">Akceptuj</button>
  <button onclick="cancelEditPlanet()">Anuluj</button>
</div>
    
    <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
    <h2>Lista planet</h2>
    <div id="planetList"></div>
  </div>

  <!-- ZakÅ‚adka PUNKTY -->
  <div id="punkty" class="tab-content">
    <label>Sortuj:</label>
    <select id="sortPoints" onchange="refreshPointsList()">
      <option value="nameAsc">Nazwa Aâ€“Z</option>
      <option value="nameDesc">Nazwa Zâ€“A</option>
      <option value="type">Typ</option>
      <option value="newest">Najnowsze</option>
      <option value="oldest">Najstarsze</option>
    </select>
    <ul id="pointsList"></ul>
  </div>

  <!-- ZakÅ‚adka DETALE PLANETY -->
<div id="detale" class="tab-content">
  <label>Galaktyka</label><input type="text" id="detailGalaxy" />
  <label>Region</label><input type="text" id="detailRegion" />
  <label>UkÅ‚ad planetarny</label><input type="text" id="detailSystem" />

  <label>Biom</label>
  <select id="detailBiome">
    <option value="">-- wybierz --</option>
    <option>Bujna</option>
    <option>JaÅ‚owa</option>
    <option>Martwa</option>
    <option>Egzotyczna</option>
    <option>Mega Egzotyczna</option>
    <option>Spalona</option>
    <option>ZamroÅ¼ona</option>
    <option>Toksyczna</option>
    <option>Napromieniowana</option>
    <option>Bagno</option>
    <option>Wulkaniczna</option>
    <option>Gazowy Gigant</option>
  </select>

  <label>Pogoda</label>
<select id="detailWeather">
  <option value="">-- wybierz --</option>
<option>Brak atmosfery</option>
    <option>SÅ‚onecznie</option>
    <option>ChÅ‚odno</option>
    <option>MroÅºno</option>
    <option>CiepÅ‚o</option>
    <option>GorÄ…co</option>
    <option>Wilgotno</option>
    <option>Deszczowo</option>
    <option>Burzowo</option>
    <option>Radioaktywne</option>
    <option>Toksyczne</option>
    <option>Kwasyczne</option>
    <option>PyÅ‚owe</option>
    <option>Wulkaniczne</option>
    <option>Burze piaskowe</option>
    <option>Tornada</option>
    <option>Meteoryty</option>
    <option>Burze ogniste</option>
    <option>Wysokie ciÅ›nienie</option>
    <option>Niskie ciÅ›nienie</option>
    <option>Burze magnetyczne</option>
    <option>Burze elektryczne</option>
</select>

  <label>StraÅ¼nicy</label>
  <select id="detailSentinels">
    <option value="">-- wybierz --</option>
    <option>Pasywne</option>
    <option>Brak</option>
    <option>Zrelaksowane</option>
    <option>Ograniczone</option>
    <option>Niskie</option>
    <option>Niskie bezpieczeÅ„stwo</option>
    <option>Minimalne</option>
    <option>Aktywne</option>
    <option>Åšrednie</option>
    <option>Standardowe</option>
    <option>Typowe</option>
    <option>UwaÅ¼ne</option>
  </select>

  <label>Flora</label>
  <select id="detailFlora">
    <option value="">-- wybierz --</option>
    <option>Brak</option>
    <option>Sporadyczna</option>
    <option>SkÄ…pa</option>
    <option>Åšrednia</option>
    <option>Obfita</option>
    <option>Ekstremalna</option>
  </select>

  <label>Fauna</label>
  <select id="detailFauna">
    <option value="">-- wybierz --</option>
    <option>Brak</option>
    <option>Sporadyczna</option>
    <option>SkÄ…pa</option>
    <option>Åšrednia</option>
    <option>Obfita</option>
    <option>Ekstremalna</option>
  </select>

  <label>Odkryty przez</label><input type="text" id="detailDiscovered" />

  <label>Tryb gry</label>
  <select id="detailMode">
    <option value="">-- wybierz --</option>
    <option>Normalny</option>
    <option>Kreatywny</option>
    <option>Survival</option>
    <option>Permadeath</option>
  </select>

  <label>Zaktualizowano</label><input type="text" id="detailUpdated" />
  <label>Koordynaty</label><input type="text" id="detailCoords" />
  <!-- Przycisk przejdÅº do NMS Portals -->
<button onclick="window.open('https://nmsportals.github.io', '_blank')" 
        style="margin-top:0.5rem; background:#1976d2; color:white; padding:0.5rem; border:none; border-radius:4px; cursor:pointer;">
  PrzejdÅº do NMS Portals
</button>
  
  <label>Notatki planety</label><textarea id="detailNotes"></textarea>
  <button onclick="savePlanetDetails()">Zapisz opis planety</button>
</div>
</div>

<div id="globeWrapper" style="position: relative;">

  <!-- nagÅ‚Ã³wek overlay -->
  <div id="planetOverlayHeader"></div>

<!-- nagÅ‚Ã³wek moja lokalizacja -->
<div id="myLocationBox" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:0.5rem; border-radius:8px; z-index:10;">
  <div style="font-weight:bold; margin-bottom:0.5rem;">Moja lokalizacja</div>
  <label>X: <input type="number" id="myLat" step="0.01" style="width:70px;"></label>
  <label>Y: <input type="number" id="myLng" step="0.01" style="width:70px; margin-left:0.5rem;"></label>
</div>

  <!-- glob -->
  <div id="globeViz"></div>
</div>

<script>
let atlas = {};
let planetDetails = {};
let planetData = [];
let currentPlanet = null;
let pointScale = parseFloat(document.getElementById("pointScale").value);
let editIndex = null;
let pointsDistanceMultiplier = 1;
let globeZoomMultiplier = 1;
let autoRotate = false;
let rotateSpeed = 0.001; // prÄ™dkoÅ›Ä‡ obrotu w radianach na frame
let myLocationPoint = null;  

////////////////////////////////////////////////////////////////////
//----------------- ZakÅ‚adki i inne elementy UI -----------------//
//////////////////////////////////////////////////////////////////// 

// ZakÅ‚adki
function openTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll("#tabs button").forEach(el => el.classList.remove("active"));
  const tab = document.getElementById(tabId);
  if(tab) tab.classList.add("active");
  // oznacz odpowiedni przycisk jako active (przybliÅ¼one dopasowanie)
  document.querySelectorAll("#tabs button").forEach(btn=>{
    if (btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(`'${tabId}'`)) btn.classList.add("active");
  });
updateCurrentPlanetHeader();
}
  
//zmiana nagÅ‚Ã³wka z nazwÄ… planety
function updateCurrentPlanetHeader() {
  const overlay = document.getElementById("planetOverlayHeader");
  if (overlay) {
    overlay.textContent = currentPlanet
      ? `${currentPlanet}`
      : "Brak wybranej planety";
  }
}

function updateNoPlanetsMessage() {
  const msg = document.getElementById("noPlanetsMessage");
  const planets = Object.keys(atlas);
  if (planets.length === 0) {
    msg.style.display = "block";
  } else {
    msg.style.display = "none";
  }
}

// Detale planety (zaÅ‚oÅ¼yÅ‚eÅ› te funkcje wczeÅ›niej â€” zostawiamy je dziaÅ‚ajÄ…ce)
function loadPlanetDetails(){
  if(!currentPlanet) return;
  const details=planetDetails[currentPlanet]||{};
  document.getElementById("detailGalaxy").value=details.galaxy||"";
  document.getElementById("detailRegion").value=details.region||"";
  document.getElementById("detailSystem").value=details.system||"";
  document.getElementById("detailBiome").value=details.biome||"";
  document.getElementById("detailWeather").value=details.weather||"";
  document.getElementById("detailSentinels").value=details.sentinels||"";
  document.getElementById("detailFlora").value=details.flora||"";
  document.getElementById("detailFauna").value=details.fauna||"";
  document.getElementById("detailDiscovered").value=details.discovered||"";
  document.getElementById("detailMode").value=details.mode||"";
  document.getElementById("detailUpdated").value=details.updated||"";
  document.getElementById("detailCoords").value=details.coords||"";
  document.getElementById("detailNotes").value=details.notes||"";
}
function savePlanetDetails(){
  if(!currentPlanet) return;
  planetDetails[currentPlanet]={
    galaxy:document.getElementById("detailGalaxy").value,
    region:document.getElementById("detailRegion").value,
    system:document.getElementById("detailSystem").value,
    biome:document.getElementById("detailBiome").value,
    weather:document.getElementById("detailWeather").value,
    sentinels:document.getElementById("detailSentinels").value,
    flora:document.getElementById("detailFlora").value,
    fauna:document.getElementById("detailFauna").value,
    discovered:document.getElementById("detailDiscovered").value,
    mode:document.getElementById("detailMode").value,
    updated:document.getElementById("detailUpdated").value,
    coords:document.getElementById("detailCoords").value,
    notes:document.getElementById("detailNotes").value
  };
  alert("Opis zapisany!");
  refreshPlanetList();
  updateCurrentPlanetHeader();
}
  
////////////////////////////////////////////////////////////////////
//------------------ Planety, lista, tworzenie -------------------//
//////////////////////////////////////////////////////////////////// 
  
// Dodawanie nowych planet
  function checkNewPlanetInput() {
  const input = document.getElementById("newPlanetName");
  const button = document.getElementById("addPlanetBtn");
  button.disabled = input.value.trim() === "";
}

  //Tworzy teksturÄ™ o rozmairze 1 piksel x 1 piksel o zadanym kolorze i zmienia na base64
function hexToBase64Texture(hex) {
  // Tworzymy canvas 1x1
  const canvas = document.createElement("canvas");
  canvas.width = 1;
  canvas.height = 1;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = hex;
  ctx.fillRect(0, 0, 1, 1);

  // Zamiana na base64 PNG
  return canvas.toDataURL("image/png");
}
  
function addNewPlanet() {
  const input = document.getElementById("newPlanetName");
  const name = input.value.trim();
  if (!name) return;

  if (atlas[name]) {
    alert("Planeta juÅ¼ istnieje!");
    return;
  }

  // wybÃ³r koloru
  const colorHex = document.getElementById("PlanetColor").value || "#000000";
  const textureBase64 = hexToBase64Texture(colorHex);
  
  atlas[name] = [];
  addPoles(name);
  
  // Dodaj pustÄ… strukturÄ™ detali od razu:
  planetDetails[name] = {
    galaxy: "",
    region: "",
    system: "",
    biome: "",
    weather: "",
    sentinels: "",
    flora: "",
    fauna: "",
    discovered: "",
    mode: "",
    updated: "",
    coords: "",
    notes: ""
  };
  // Dodanie nowego wpisu do planetData
  planetData.push({
    name: name,
    texture: textureBase64,  // Przypisanie koloru planety w formie tekstury
    extraInfo: {}, // miejsce na dodatkowe, niestandardowe dane planety
    createdAt: Date.now() //automatycznie zapisany czas dodania planety
    
  });
  currentPlanet = name;
  updateCurrentPlanetHeader();
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();

  // Ustaw od razu glob na wybranÄ… teksturÄ™
  globe.globeImageUrl(textureBase64);
  
    input.value = "";
  checkNewPlanetInput();
  alert(`Dodano nowÄ… planetÄ™: ${name}`);
  updateNoPlanetsMessage()
}
  
// Lista planet

// Zwraca dane do renderowania â€“ tylko sortowanie i grupowanie
function getGroupedPlanets() {
  const createdAtMap = {};
  (planetData || []).forEach(pd => {
    if (pd && pd.name) createdAtMap[pd.name] = pd.createdAt || 0;
  });

  const systems = { "Nieznany": [] };

  Object.keys(atlas).forEach(p => {
    const system = (planetDetails[p]?.system || "").trim();
    if (system) {
      if (!systems[system]) systems[system] = [];
      systems[system].push(p);
    } else {
      systems["Nieznany"].push(p);
    }
  });

  const INF = Number.MAX_SAFE_INTEGER;

  const systemTimestamps = {};
  Object.keys(systems).forEach(system => {
    const times = systems[system].map(name => createdAtMap[name] || INF);
    systemTimestamps[system] = times.length ? Math.min(...times) : INF;
  });

  const sortedSystems = Object.keys(systems).sort((a, b) => {
    if (a === "Nieznany") return -1;
    if (b === "Nieznany") return 1;
    return systemTimestamps[a] - systemTimestamps[b];
  });

  // zwracamy gotowÄ… strukturÄ™ do wyrenderowania
  return sortedSystems.map(system => ({
    name: system,
    planets: systems[system].sort((p1, p2) =>
      (createdAtMap[p1] || INF) - (createdAtMap[p2] || INF)
    )
  }));
}
// Renderuje nagÅ‚Ã³wki i planety.
  
function refreshPlanetList() {
  const list = document.getElementById("planetList");
  if (!list) return;

  list.innerHTML = "";
  const grouped = getGroupedPlanets();

  const frag = document.createDocumentFragment();

  grouped.forEach(system => {
    const header = document.createElement("h3");
    header.textContent = "UkÅ‚ad planetarny: " + system.name;
    header.style.margin = "0.5rem 0";
    header.style.color = system.name === "Nieznany" ? "#aaa" : "#ffcc00";
    frag.appendChild(header);

    system.planets.forEach(p => {
      // tutaj wklejasz kod do renderowania wiersza planety (btn + UsuÅ„)
      frag.appendChild(renderPlanetRow(p));
    });
  });

  list.appendChild(frag);
  updateNoPlanetsMessage();
}

// Tworzy pojedynczy wiersz
function renderPlanetRow(p) {
  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.alignItems = "center";
  container.style.margin = "0.2rem 0";

  const btn = document.createElement("button");
  btn.textContent = p;
  btn.style.flex = "1";
  btn.style.marginRight = "0.5rem";
  btn.style.background = "#e5e5e5";
  btn.style.color = "black";
  btn.style.border = "none";
  btn.style.padding = "0.3rem";
  btn.style.borderRadius = "4px";
  btn.style.cursor = "pointer";

// ðŸ”¥ PodÅ›wietlanie wybranej planety
  if (p === currentPlanet) {
    btn.style.background = "#1976d2";  // niebieski
    btn.style.color = "white";
    btn.style.fontWeight = "bold";
  }
  
  btn.onclick = () => {
    currentPlanet = p;
    updateCurrentPlanetHeader();
    addPoles(p);
    refreshGlobePoints();
    globe.htmlElementsData(atlas[p].filter(pt => pt.type === "Pole"));
    refreshPointsList();
    loadPlanetDetails();
    selectPlanet(p);
    updateSelectedPlanetButtons();
    refreshPlanetList(); // <-- odÅ›wieÅ¼ listÄ™, Å¼eby przeÅ‚Ä…czyÄ‡ podÅ›wietlenie
  };

  container.appendChild(btn);
  return container;
}
  
 // Funkcja pomocnicza do aktualizacji planetData
function updatePlanetData(name, extra = {}) {
  const idx = planetData.findIndex(pd => pd.name === name);
  if (idx !== -1) {
    // aktualizacja istniejÄ…cego wpisu
    planetData[idx].extraInfo = {...planetData[idx].extraInfo, ...extra};
  } else {
    // jeÅ›li planeta nie istnieje, dodaj nowÄ…
    planetData.push({
      name: name,
      extraInfo: extra,
      createdAt: Date.now()
    });
  }
}
//Jest to uniwersalna funkcja updatePlanetData, ktÃ³ra utrzymuje spÃ³jnoÅ›Ä‡ tablicy planetData;
//MoÅ¼na Å‚atwo dodawaÄ‡ dodatkowe informacje do planet, bez zmieniania istniejÄ…cych struktur atlas i planetDetails;
//Nie zmienia siÄ™ istniejÄ…cy mechanizm dodawania, edycji ani usuwania planet â€“ wszystko jest kompatybilne.

// Funkcja aktualizujÄ…ca stan przyciskÃ³w w zaleÅ¼noÅ›ci od tego, czy planeta jest zaznaczona
function updateSelectedPlanetButtons() {
  const editBtn = document.getElementById("editSelectedPlanetBtn");
  const delBtn  = document.getElementById("deleteSelectedPlanetBtn");
  const enabled = !!currentPlanet;
  editBtn.disabled = !enabled;
  delBtn.disabled = !enabled;
}

// WywoÅ‚ujemy po kaÅ¼dej zmianie zaznaczenia planety
function selectPlanet(name) {
  const planet = planetData.find(p => p.name === name);
  if (!planet) return;
  currentPlanet = planet.name;
  updateCurrentPlanetHeader();
  globe.globeImageUrl(planet.texture || blackTextureURL);
  updateSelectedPlanetButtons();
}

// Edycja zaznaczonej planety
function editSelectedPlanet() {
  if (!currentPlanet) {
    alert("Najpierw zaznacz planetÄ™.");
    return;
  }
 }

function acceptEditPlanet() {
  const newName = document.getElementById("editPlanetName").value.trim();
  if (!newName) {
    alert("Podaj nowÄ… nazwÄ™ planety.");
    return;
  }

  // przenieÅ› dane planety pod nowÄ… nazwÄ™
  atlas[newName] = atlas[currentPlanet];
  delete atlas[currentPlanet];

  planetDetails[newName] = planetDetails[currentPlanet] || {};
  delete planetDetails[currentPlanet];

  const idx = planetData.findIndex(p => p.name === currentPlanet);
  if (idx !== -1) planetData[idx].name = newName;

  // ustaw nowÄ… nazwÄ™ jako aktywnÄ…
  currentPlanet = newName;

  refreshPlanetList();
  updateCurrentPlanetHeader();
  updateSelectedPlanetButtons();

  document.getElementById("editPlanetBox").style.display = "none";
  }

function cancelEditPlanet() {
  // po prostu chowamy formularz
  document.getElementById("editPlanetBox").style.display = "none";
  }
  
// UsuniÄ™cie zaznaczonej planety z potwierdzeniem
function deleteSelectedPlanet() {
  if (!currentPlanet) return;
  if (!confirm(`Czy na pewno usunÄ…Ä‡ planetÄ™ "${currentPlanet}" wraz ze wszystkimi punktami?`)) return;

  delete atlas[currentPlanet];
  delete planetDetails[currentPlanet];
  const idx = planetData.findIndex(p => p.name === currentPlanet);
  if (idx !== -1) planetData.splice(idx, 1);

  const planets = Object.keys(atlas);
  currentPlanet = planets.length ? planets[0] : null;
  
  updateCurrentPlanetHeader();
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();
  updateSelectedPlanetButtons();
}

// WywoÅ‚anie przy starcie, Å¼eby przyciski byÅ‚y poprawnie wyszarzone jeÅ›li brak planet
updateSelectedPlanetButtons();
  
////////////////////////////////////////////////////////////////////
//--------------- Punkty, lista, tworzenie, edycja ---------------//
//////////////////////////////////////////////////////////////////// 
  
// Lista punktow
function refreshPointsList(){
  const list = document.getElementById("pointsList");
  list.innerHTML = "";
  if(!currentPlanet || !atlas[currentPlanet]) return;

  let points = atlas[currentPlanet].filter(p => p.type !== "Pole");
  const sort = document.getElementById("sortPoints").value;
  if(sort==="nameAsc") points.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  if(sort==="nameDesc") points.sort((a,b)=> (b.name||"").localeCompare(a.name||""));
  if(sort==="type") points.sort((a,b)=> (a.type||"").localeCompare(b.type||""));
  if(sort==="newest") points.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
  if(sort==="oldest") points.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));

  points.forEach((point,index)=>{
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.flexDirection = "column";
    li.style.alignItems = "flex-start";

    const info = document.createElement("span");
    info.innerHTML = `${point.name || "Bez nazwy"} (${point.type})<br>X:${point.lat}, Y:${point.lng}`;
    li.appendChild(info);

    const btnDiv = document.createElement("div");
    btnDiv.style.display = "flex";
    btnDiv.style.gap = "0.5rem";

    // Przycisk "PokaÅ¼ punk na globie"
    const showBtn = document.createElement("button");
    showBtn.textContent = "PokaÅ¼";
    showBtn.className = "show";
    showBtn.style.background = "#388e3c";
    showBtn.style.color = "white";
    showBtn.onclick = () => {
      globe.pointOfView({ lat: point.lat, lng: point.lng, altitude: 1.5 }, 1000);

      // podÅ›wietlenie punktu
      point.__highlight = true;
      globe.pointColor(d=>{
        if(d.__highlight) return "orange";
        switch(d.type){
        case "ZasÃ³b": return d.extracted ? "gray" : "gold";
        case "Baza": return "blue";
        case "Ruiny": return d.visited ? "lime" : "orange";
        case "Struktura": return d.visited ? "cyan" : "magenta";
        case "Inne": return d.visited ? "purple" : "brown";
        case "Pole": return "red";
        default: return "red";
        }
      });
      globe.pointsData(atlas[currentPlanet]);
      setTimeout(()=>{
        delete point.__highlight;
        globe.pointsData(atlas[currentPlanet]);
      },2000);
    };
    btnDiv.appendChild(showBtn);

      if(point.type==="ZasÃ³b" || ["Inne","Ruiny","Struktura"].includes(point.type)){
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = point.type==="ZasÃ³b" ? point.extracted : point.visited;
      checkbox.onchange = ()=>{
        if(point.type==="ZasÃ³b") point.extracted = checkbox.checked;
          else point.visited = checkbox.checked;  // dla nowych typÃ³w
          refreshGlobePoints();
          refreshPointsList();
      };
      btnDiv.appendChild(checkbox);
    }

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edytuj";
    editBtn.className = "edit";
    editBtn.onclick = ()=>editPoint(point.timestamp);  // Musimy jednoznacznie wskazaÄ‡ ktÃ³ry punkt w atlasie edytujemy. NajproÅ›ciej przekazywaÄ‡ nie indeks, tylko unikalny identyfikator (timestamp, ktÃ³ry juÅ¼ dodajemy do kaÅ¼dego punktu).
    btnDiv.appendChild(editBtn);

   const delBtn = document.createElement("button");
delBtn.textContent = "UsuÅ„";
delBtn.className = "del";
delBtn.onclick = ()=>{
  if(confirm(`Czy na pewno usunÄ…Ä‡ punkt "${point.name || "Bez nazwy"}" typu "${point.type}" o wspÃ³Å‚rzÄ™dnych X:${point.lat}, Y:${point.lng}?`)){
  const idx = atlas[currentPlanet].findIndex(p => p.timestamp === point.timestamp);
  if(idx !== -1){
    atlas[currentPlanet].splice(idx,1);
    refreshPointsList();
    refreshGlobePoints();
    }
  }
};
btnDiv.appendChild(delBtn);

    li.appendChild(btnDiv);
    list.appendChild(li);
  });
}

// KlikniÄ™cie Edytuj nie usuwa punktu od razu.
//Punkt jest tymczasowo przygotowany do edycji (Å‚aduje siÄ™ do formularza).
//Dopiero klikniÄ™cie Nadpisz punkt faktycznie zmienia dane.
//Jak klikniesz â€žPunktyâ€ bez zapisania â†’ lista zostaje nietkniÄ™ta.
//Przycisk zmienia podpis w zaleÅ¼noÅ›ci od trybu.
  
function addPoint(){
  if (!currentPlanet) {
    alert("Najpierw wybierz planetÄ™ w zakÅ‚adce 'Planety'!");
    return;
  }

  const lat = parseFloat(document.getElementById("lat").value);
  const lng = parseFloat(document.getElementById("lng").value);
  const name = document.getElementById("name").value.trim();
  const type = document.getElementById("type").value;
  const notes = document.getElementById("notes").value.trim();

  // Sprawdzenie duplikatu
  const exists = atlas[currentPlanet].some(p =>
    p.lat === lat &&
    p.lng === lng &&
    p.name === name &&
    p.type === type &&
    p.notes === notes
  );
  if (exists) {
    alert(`Punkt typu "${type}" o wspÃ³Å‚rzÄ™dnych X:${lat}, Y:${lng} z takÄ… samÄ… notatkÄ… juÅ¼ istnieje!`);
    return;
  }
  
  if (isNaN(lat) || isNaN(lng)) {
    alert("Podaj wspÃ³Å‚rzÄ™dne X i Y!");
    return;
  }

  const point = {planet: currentPlanet, lat, lng, name, type, notes, timestamp: Date.now()};
  if(type==="ZasÃ³b") point.extracted=false;
  if(["Inne", "Ruiny", "Struktura"].includes(type)) point.visited = false;
 if (editIndex !== null && atlas[currentPlanet][editIndex]) {
  atlas[currentPlanet][editIndex] = point;
  // po nadpisaniu resetujemy stan edycji i chowamy Anuluj
  cancelEditPoint();
} else {
  atlas[currentPlanet].push(point);
}
  refreshPlanetList();
  refreshGlobePoints();
  refreshPointsList();
}

function editPoint(timestamp){   
  if(!currentPlanet || !atlas[currentPlanet]) return;
  
  const index = atlas[currentPlanet].findIndex(p => p.timestamp === timestamp);
  if(index === -1) return;

  const p = atlas[currentPlanet][index];
  document.getElementById("lat").value = p.lat;
  document.getElementById("lng").value = p.lng;
  document.getElementById("name").value = p.name;
  document.getElementById("type").value = p.type;
  document.getElementById("notes").value = p.notes;

  editIndex = index; // zapamiÄ™taj indeks prawidÅ‚owego punktu w atlasie
  const addBtn = document.querySelector("button[onclick='addPoint()']");
  addBtn.textContent = "Nadpisz punkt";

  showCancelEditButton();

  // przeÅ‚Ä…czenie na zakÅ‚adkÄ™ START
  openTab('start');
}

function showCancelEditButton() {
  let cancelBtn = document.getElementById("cancelEditBtn");
  if (!cancelBtn) {
    const addBtn = document.querySelector("button[onclick='addPoint()']");
    
    // kontener na przyciski, jeÅ›li jeszcze nie istnieje
    let btnWrapper = document.getElementById("editBtnWrapper");
    if (!btnWrapper) {
      btnWrapper = document.createElement("div");
      btnWrapper.id = "editBtnWrapper";
      btnWrapper.style.display = "flex";
      btnWrapper.style.flexDirection = "column";
      btnWrapper.style.gap = "0.5rem";
      addBtn.parentNode.insertBefore(btnWrapper, addBtn);
      btnWrapper.appendChild(addBtn);
    }

    cancelBtn = document.createElement("button");
    cancelBtn.id = "cancelEditBtn";
    cancelBtn.textContent = "Anuluj";
    cancelBtn.style.backgroundColor = "#d32f2f"; // czerwony
    cancelBtn.style.color = "white";
    cancelBtn.style.border = "none";
    cancelBtn.style.padding = "0.5rem";
    cancelBtn.style.borderRadius = "6px";
    cancelBtn.style.cursor = "pointer";
    cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = "#b71c1c";
    cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = "#d32f2f";

    cancelBtn.onclick = cancelEditPoint;

    btnWrapper.appendChild(cancelBtn);
  }
}

function cancelEditPoint() {
  editIndex = null;
  const addBtn = document.querySelector("button[onclick='addPoint()']");
  addBtn.textContent = "Dodaj punkt";

  const cancelBtn = document.getElementById("cancelEditBtn");
  if(cancelBtn) cancelBtn.remove();

  document.getElementById("lat").value = "";
  document.getElementById("lng").value = "";
  document.getElementById("name").value = "";
  document.getElementById("type").value = "ZasÃ³b";
  document.getElementById("notes").value = "";
}

// Utomatyczne tworzenie biegunÃ³w
function addPoles(planet){
  if(!atlas[planet]) atlas[planet] = [];
  if(!atlas[planet].some(p => p.type==="Pole")){
    atlas[planet].push({lat:90,lng:0,name:"Biegun PÃ³Å‚nocny",type:"Pole"});
    atlas[planet].push({lat:-90,lng:0,name:"Biegun PoÅ‚udniowy",type:"Pole"});
  }
}

// Funkcja tworzÄ…ca teksturÄ™ z gwiazdkÄ…
function createStarTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 64;
    canvas.height = 64;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '48px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = 'yellow'; // kolor gwiazdki
    ctx.fillText('â­', canvas.width/2, canvas.height/2);
    const texture = new THREE.CanvasTexture(canvas);
    return texture;
}

 function updateMyLocation() {
  const lat = parseFloat(document.getElementById("myLat").value);
  const lng = parseFloat(document.getElementById("myLng").value);

  if (isNaN(lat) || isNaN(lng)) {
    myLocationPoint = null;
  } else {
    myLocationPoint = { 
      lat, 
      lng, 
      altitude: 0.02, 
      type: "Moja", 
     };
  }

  refreshGlobePoints(); // rysujemy razem z resztÄ…
}

document.getElementById("myLat").addEventListener("input", updateMyLocation);
document.getElementById("myLng").addEventListener("input", updateMyLocation);

// odÅ›wieÅ¼amy glob z uwzglÄ™dnieniem mnoÅ¼nika wysokoÅ›ci
  function refreshGlobePoints(){
  if (!currentPlanet) return;
// kopiujemy punkty z atlasu
  let allPoints = atlas[currentPlanet] ? [...atlas[currentPlanet]] : [];

  if (myLocationPoint) {
    allPoints.push(myLocationPoint); // tu dodajemy gwiazdkÄ™
  }

  globe.pointsData(allPoints)
     .pointAltitude(d => (d.altitude || 0.02) * pointsDistanceMultiplier);
  globe.htmlElementsData(allPoints.filter(d => d.type === "Pole" || d.type === "Moja"));
  }
  
////////////////////////////////////////////////////////////////////
//------------------- Tekstury i kolory planet -------------------//
////////////////////////////////////////////////////////////////////  

function addTextureUrl() {
  const texture = document.getElementById('planetTextureUrl').value.trim();
  if (!texture) {
  alert("Podaj URL tekstury!");
  return;
  }

  // ZnajdÅº wpis planety w planetData
  const planet = planetData.find(p => p.name === currentPlanet);
  if (planet) {
    planet.texture = texture; // dodaj/aktualizuj teksturÄ™
  } 
  // Nadpisanie tekstury (moÅ¼e byÄ‡ URL lub DataTexture)
  planet.texture = texture;
  // ustaw od razu na globie
  globe.globeImageUrl(texture);
  alert(`Dodano teksturÄ™ do planety ${currentPlanet}`);
}

  // PrzeÅ‚Ä…cznik aktywnej planety
  function selectPlanet(name) {
  // Szuka w tablicy planet obiektu, ktÃ³ry ma taki sam 'name'
    const planet = planetData.find(p => p.name === name);
  // JeÅ›li nic nie znalazÅ‚a â†’ koÅ„czy dziaÅ‚anie
    if (!planet) return; 

  // Ustawia globalnÄ… zmiennÄ… currentPlanet na tÄ™ planetÄ™
    currentPlanet = planet.name;
       
  // UÅ¼ywamy tekstury planety jeÅ›li istnieje, w przeciwnym razie czarna
  const textureToUse = planet.texture ? planet.texture : blackTextureURL;
globe.globeImageUrl(textureToUse);
}

  // Funkcja do zmiany koloru planety
function changePlanetColor() {
  if (!currentPlanet) {
    alert("Najpierw wybierz planetÄ™!");
    return;
  }

  const colorHex = document.getElementById("PlanetColor").value || "#000000";
  const textureBase64 = hexToBase64Texture(colorHex);

  // znajdÅº wpis w planetData
  const idx = planetData.findIndex(p => p.name === currentPlanet);
  if (idx !== -1) {
    planetData[idx].texture = textureBase64;
    globe.globeImageUrl(textureBase64);
    }
}

   // Funkcja sprawdzajÄ…ca, czy w polu tekstury coÅ› wpisano 
function checkTextureInput() {
  const input = document.getElementById("planetTextureUrl");
  const button = input.nextElementSibling; // przycisk obok pola
  button.disabled = input.value.trim() === "";
}
  
////////////////////////////////////////////////////////////////////
//---------------- Eksport / Import Atlasu ---------------//
////////////////////////////////////////////////////////////////////  

function exportAtlas(){
  const blob = new Blob([JSON.stringify({atlas,planetDetails, planetData},null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      if(data.atlas) atlas = data.atlas;
      if(data.planetDetails) planetDetails = data.planetDetails;
      if(data.planetData) planetData = data.planetData; // Wczytanie planetData
      // ustaw pierwszÄ… planetÄ™ jako currentPlanet
      const planets = Object.keys(atlas);
     currentPlanet = planets[0] || null;
      updateCurrentPlanetHeader(); // aby nagÅ‚Ã³wek byÅ‚ poprawny nawet jeÅ›li currentPlanet jest null
      refreshPlanetList();
      refreshPointsList();
      refreshGlobePoints();
      updateNoPlanetsMessage()

      alert("Import zakoÅ„czony!");
    } catch(err){ alert("BÅ‚Ä…d importu JSON"); }
  };
  reader.readAsText(file);
}

////////////////////////////////////////////////////////////////////
//---------------- Skalowanie Globu i PunktÃ³w ----------------//
////////////////////////////////////////////////////////////////////  
  
// Skalowanie punktÃ³w
function updatePointScale(){
  pointScale = parseFloat(document.getElementById("pointScale").value);
  document.getElementById("pointScaleValue").textContent = pointScale;
  refreshGlobePoints();
}
function resetPointScale(){
  document.getElementById("pointScale").value = 0.4;
  updatePointScale();
}

// Sklaowanie wysokoÅ›ci sÅ‚upka
function updatePointsDistanceMultiplier() {
  pointsDistanceMultiplier = parseFloat(document.getElementById("pointsDistanceMultiplier").value);
  document.getElementById("pointsDistanceMultiplierValue").textContent = pointsDistanceMultiplier;
  refreshGlobePoints();
}
function resetPointsDistanceMultiplier(){
  document.getElementById("pointsDistanceMultiplier").value = 1;
  updatePointsDistanceMultiplier();
}

//Skalowanie wielkoÅ›ci planety
function updateGlobeZoomMultiplier() {
  globeZoomMultiplier = parseFloat(document.getElementById("globeZoomMultiplier").value);
  document.getElementById("globeZoomMultiplierValue").textContent = globeZoomMultiplier;
  globe.scene().scale.set(globeZoomMultiplier, globeZoomMultiplier, globeZoomMultiplier);
}
function resetGlobeZoomMultiplier(){
  document.getElementById("globeZoomMultiplier").value = 1;
  updateGlobeZoomMultiplier();
}

function toggleAutoRotate() {
  const controls = globe.controls();
  if (document.getElementById("autoRotateCheckbox").checked) {
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.7; // prÄ™dkoÅ›Ä‡ obrotu, moÅ¼esz zmieniaÄ‡
  } else {
    controls.autoRotate = false;
  }
}
  
////////////////////////////////////////////////////////////////////
//---------------------- Inicjalizacja globu ---------------------//
//////////////////////////////////////////////////////////////////// 
  
  // Tworzymy czarnÄ… teksturÄ™ globalnie, ktÃ³ra zastÄ…pi globeImageUrl(null). 
  // Podczas tworzenia planet, jeÅ›li od razu nie przypisywaliÅ›my tekstury i pozstawialiÅ›my pusty glob
  // to generowaÅ‚o to bÅ‚Ä™dy podczas przeÅ‚Ä…czania siÄ™ miÄ™dzy planetami na liÅ›cie planet - nie wyÅ›wietlaÅ‚o poprawnie globu. 
  
  const blackTextureURL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";

  
  // Inicjalizacja globu â€” uÅ¼ywamy https aby tÅ‚o zawsze siÄ™ zaÅ‚adowaÅ‚o
const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null) // brak domyÅ›lnej mapy (pusta/ciemna kula)
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png') // ðŸŒŒ gwiazdy w tle

  .pointLat("lat")
  .pointLng("lng")
  .pointLabel(d => {
    // zabezpieczenie: gdy nie ma currentPlanet, zwracamy opis punktu pojedynczo
    if (!currentPlanet || !atlas[currentPlanet]) {
      let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
      if (d.type === "ZasÃ³b") label += d.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
      if (d.type === "Obelisk") label += d.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
      return label;
    }

    // grupowanie punktÃ³w w tym samym miejscu dla aktualnej planety
    const sameLocation = atlas[currentPlanet].filter(p => p.lat === d.lat && p.lng === d.lng);
    if (sameLocation.length > 1) {
      return sameLocation.map(p => {
        let label = `${p.name || "Bez nazwy"} (${p.type})`;
        if (p.type === "ZasÃ³b") label += p.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
        if (p.type === "Obelisk") label += p.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
        return label;
      }).join("<br>");
    }

    let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
    if (d.type === "ZasÃ³b") label += d.extracted ? " [Wydobyty]" : " [Nie wydobyty]";
    if (d.type === "Obelisk") label += d.visited ? " [Odwiedzony]" : " [Nie odwiedzony]";
    return label;
  })
  .pointColor(d=>{
    switch(d.type){
      case "ZasÃ³b": return d.extracted?"gray":"gold";
      case "Baza": return "blue";
      case "Ruiny": return "brown";
      case "Struktura": return "purple";
      case "Inne": return "pink";
      case "Pole": return "red";
      default: return "red";
    }
  })
  .pointRadius(() => pointScale)
  .htmlElementsData([])
  .htmlElement(d=>{
    if(d.type==="Pole"){
      const el=document.createElement("div");
      el.style.color="white";
      el.style.fontSize="20px";
      el.style.fontWeight="bold";
      el.style.textShadow="0 0 4px black";
      el.textContent=d.name==="Biegun PÃ³Å‚nocny"?"N":"S";
      return el;
    }
    if (d.type === "Moja") {
      const el = document.createElement("div");
      el.style.color = "yellow";
      el.style.fontSize = "22px";
      el.style.fontWeight = "bold";
      el.style.textShadow = "0 0 6px black";
      el.textContent = "â­";
      return el;
    }
  });

// ustawienie punktÃ³w dla aktualnej planety
if (currentPlanet && atlas[currentPlanet]) {
  globe.pointsData(atlas[currentPlanet]);
  globe.htmlElementsData(atlas[currentPlanet].filter(p => p.type === "Pole"));
}

globe.showGraticules(true).graticuleLineWidth(0.5);

// start
window.onload = () => {
  openTab("start"); // aktywuj pierwszÄ… zakÅ‚adkÄ™
  refreshPlanetList();
  refreshPointsList();
  updateNoPlanetsMessage();
  updateCurrentPlanetHeader()
  };

</script>
</body>
</html>
