<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<style>
body{margin:0;display:flex;height:100vh;font-family:Arial,sans-serif;background:#0d1b2a;color:#e0e6ed;overflow:hidden;}
#form{flex:0 0 600px;padding:1rem;background:#1b263b;overflow-y:auto;box-sizing:border-box;}
#globeViz{flex:1;position:relative;width:100%;height:100%;}
h2{margin-top:1rem;margin-bottom:0.5rem;color:#f0f4f8;}
label{font-weight:bold;margin-top:0.5rem;display:block;}
input,select,textarea,button{width:100%;margin:0.3rem 0;padding:0.4rem;box-sizing:border-box;border:none;border-radius:4px;}
input,select,textarea{background:#24344d;color:#f0f4f8;}
button{background:#1976d2;color:white;cursor:pointer;font-weight:bold;}
button:hover{background:#1565c0;}
.grid-control{display:flex;align-items:center;gap:0.5rem;}
.grid-control input[type="number"]{flex:0 0 70px;}
.grid-control input[type="range"]{flex:1;}
ul#pointsList{padding:0;list-style:none;margin:0.3rem 0;}
ul#pointsList li{background:#24344d;margin-bottom:0.2rem;padding:0.3rem;border-radius:4px;display:flex;justify-content:space-between;align-items:center;}
ul#pointsList li div{display:flex;gap:0.3rem;}
.texture-input{display:flex;gap:0.5rem;margin-top:0.5rem;}
.checkbox-state{margin-right:5px;cursor:pointer;}
</style>
</head>
<body>
<div id="form">
<h2>Dodaj punkt</h2>
<label>Planeta</label><input type="text" id="planet" placeholder="Nazwa planety"/>
<label>X</label><input type="number" id="x" step="0.0001"/>
<label>Y</label><input type="number" id="y" step="0.0001"/>
<label>Nazwa punktu</label><input type="text" id="name"/>
<label>Typ</label>
<select id="type">
  <option>Zasób</option>
  <option>Obelisk</option>
  <option>Baza</option>
  <option>Ruiny</option>
  <option>Duża struktura</option>
  <option>Inne</option>
</select>
<label>Notatki</label><textarea id="notes"></textarea>
<button onclick="addPoint()">Dodaj punkt</button>

<h2>Planety</h2>
<div id="planetList"></div>

<h2>Punkty na planecie</h2>
<ul id="pointsList"></ul>

<h2>Tekstura planety</h2>
<div class="texture-input">
  <input type="file" id="planetTextureInput" accept="image/*" hidden/>
  <button onclick="document.getElementById('planetTextureInput').click()">Wybierz plik</button>
  <button onclick="setPlanetTextureFromInput()">Ustaw</button>
</div>

<h2>Oddal (suwak)</h2>
<div class="grid-control">
  <input type="number" id="pointScale" value="1" min="0.01" max="10" step="0.01" oninput="syncScaleInputs('number')"/>
  <input type="range" id="pointScaleRange" value="1" min="0.01" max="10" step="0.01" oninput="syncScaleInputs('range')"/>
</div>

<h2>Skala odległości punktów</h2>
<div class="grid-control">
  <input type="number" id="distanceScale" value="1" min="0.1" max="10" step="0.01" oninput="updateDistanceScale()"/>
  <input type="range" id="distanceScaleRange" value="1" min="0.1" max="10" step="0.01" oninput="updateDistanceScaleRange()"/>
</div>

<h2>Import/Eksport</h2>
<button onclick="exportAtlas()">Eksport JSON</button>
<input type="file" id="importFile" accept="application/json" onchange="importAtlas(event)"/>
</div>

<div id="globeViz"></div>

<script>
let atlas = JSON.parse(localStorage.getItem("atlas") || "{}");
let planetTextures = JSON.parse(localStorage.getItem("planetTextures") || "{}");
let currentPlanet = null;
let pointScale = 1;
let distanceScale = 1;

const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null)
  .pointLat("x")
  .pointLng("y")
  .pointLabel(d=>`<b>${d.name||""}</b><br>Typ:${d.type}<br>X:${d.x.toFixed(2)}, Y:${d.y.toFixed(2)}<br>${d.notes||""}`)
  .pointColor(d=>{
    if(d.type==="Zasób") return d.extracted?"gray":"yellow";
    if(d.type==="Obelisk") return d.visited?"green":"cyan";
    if(d.type==="Baza") return "blue";
    if(d.type==="Ruiny") return "brown";
    if(d.type==="Duża struktura") return "purple";
    if(d.type==="Inne") return "pink";
    if(d.type==="Pole") return "red";
    return "white";
  })
  .pointAltitude(d=>0.02*pointScale)
  .pointRadius(d=>0.3*pointScale)
  .htmlElementsData([])
  .htmlElement(d=>{if(d.type==="Pole"){const el=document.createElement("div");el.style.color="white";el.style.fontSize="20px";el.style.fontWeight="bold";el.style.textShadow="0 0 4px black";el.textContent=d.name.includes("Północny")?"N":"S";return el;}});

function syncScaleInputs(source){
  const num=document.getElementById("pointScale");
  const range=document.getElementById("pointScaleRange");
  if(source==="number") range.value=num.value; else num.value=range.value;
  pointScale=parseFloat(num.value);
  if(currentPlanet) globe.pointsData(atlas[currentPlanet]);
  refreshPointsList();
}

function updateDistanceScale(){
  const num=document.getElementById("distanceScale");
  const range=document.getElementById("distanceScaleRange");
  range.value=num.value;
  distanceScale=parseFloat(num.value);
  if(currentPlanet) globe.pointsData(atlas[currentPlanet]);
}
function updateDistanceScaleRange(){
  const range=document.getElementById("distanceScaleRange");
  const num=document.getElementById("distanceScale");
  num.value=range.value;
  distanceScale=parseFloat(range.value);
  if(currentPlanet) globe.pointsData(atlas[currentPlanet]);
}

function saveAtlas(){
  localStorage.setItem("atlas",JSON.stringify(atlas));
  localStorage.setItem("planetTextures",JSON.stringify(planetTextures));
}

function addPoles(planet){
  if(!atlas[planet]) atlas[planet]=[];
  if(!atlas[planet].some(p=>p.type==="Pole")){
    atlas[planet].push({x:0,y:0,name:"Biegun Północny",type:"Pole"});
    atlas[planet].push({x:0,y:0,name:"Biegun Południowy",type:"Pole"});
  }
}

function refreshPlanetList(){
  const list=document.getElementById("planetList");
  list.innerHTML="";
  Object.keys(atlas).forEach(p=>{
    const btn=document.createElement("button");
    btn.textContent=p; btn.style.width="100%"; btn.style.margin="0.2rem 0";
    btn.onclick=()=>{
      currentPlanet=p;
      document.getElementById("planet").value = p;
      addPoles(p);
      globe.pointsData(atlas[p]);
      globe.htmlElementsData(atlas[p].filter(pt=>pt.type==="Pole"));
      refreshPointsList();
    };
    list.appendChild(btn);
  });
}

function refreshPointsList(){
  const list=document.getElementById("pointsList");
  list.innerHTML="";
  if(!currentPlanet || !atlas[currentPlanet]) return;
  const pointsSorted = atlas[currentPlanet].slice().sort((a,b)=>{
    if(a.type<b.type) return -1; if(a.type>b.type) return 1;
    if((a.name||"")<(b.name||"")) return -1;
    if((a.name||"")>(b.name||"")) return 1;
    return 0;
  });
  pointsSorted.forEach((point,index)=>{
    const li=document.createElement("li");
    const info=document.createElement("span");
    info.innerHTML=`<b>${point.name||"Bez nazwy"}</b> (${point.type})<br>X:${point.x.toFixed(2)}, Y:${point.y.toFixed(2)}`;

    li.appendChild(info);
    const btnContainer=document.createElement("div");

    // Checkboxy dla Resource / Obelisk
    if(point.type==="Zasób"){
      const cb=document.createElement("input");
      cb.type="checkbox"; cb.className="checkbox-state"; cb.checked=point.extracted;
      cb.title="Wydobyty?"; cb.onchange=()=>{
        point.extracted=cb.checked;
        saveAtlas(); globe.pointsData(atlas[currentPlanet]);
        refreshPointsList();
      };
      btnContainer.appendChild(cb);
    }
    if(point.type==="Obelisk"){
      const cb=document.createElement("input");
      cb.type="checkbox"; cb.className="checkbox-state"; cb.checked=point.visited;
      cb.title="Odwiedzony?"; cb.onchange=()=>{
        point.visited=cb.checked;
        saveAtlas(); globe.pointsData(atlas[currentPlanet]);
        refreshPointsList();
      };
      btnContainer.appendChild(cb);
    }

    const editBtn=document.createElement("button");
    editBtn.textContent="Edytuj"; editBtn.style.background="#0277bd"; editBtn.style.color="white";
    editBtn.onclick=()=>editPoint(index); btnContainer.appendChild(editBtn);

    const delBtn=document.createElement("button");
    delBtn.textContent="Usuń"; delBtn.style.background="#c62828"; delBtn.style.color="white";
    delBtn.onclick=()=>{if(confirm("Czy na pewno chcesz usunąć ten punkt?")){
      atlas[currentPlanet].splice(index,1); saveAtlas(); refreshPointsList(); globe.pointsData(atlas[currentPlanet]);
    }};
    btnContainer.appendChild(delBtn);

    li.appendChild(btnContainer);
    list.appendChild(li);
  });
}

function editPoint(index){
  if(!currentPlanet || !atlas[currentPlanet]) return;
  const p=atlas[currentPlanet][index];
  document.getElementById("planet").value=currentPlanet;
  document.getElementById("x").value=p.x;
  document.getElementById("y").value=p.y;
  document.getElementById("name").value=p.name;
  document.getElementById("type").value=p.type;
  document.getElementById("notes").value=p.notes;
  atlas[currentPlanet].splice(index,1);
  saveAtlas();
  refreshPointsList();
  globe.pointsData(atlas[currentPlanet]);
}

function addPoint(){
  const planet=document.getElementById("planet").value.trim();
  const x=parseFloat(document.getElementById("x").value);
  const y=parseFloat(document.getElementById("y").value);
  const name=document.getElementById("name").value.trim();
  const type=document.getElementById("type").value;
  const notes=document.getElementById("notes").value.trim();
  if(!planet || isNaN(x) || isNaN(y)){alert("Uzupełnij planetę i współrzędne!"); return;}
  if(!atlas[planet]) atlas[planet]=[];
  const point={planet,x,y,name,type,notes,created:Date.now()};
  if(type==="Zasób") point.extracted=false;
  if(type==="Obelisk") point.visited=false;
  atlas[planet].push(point);
  currentPlanet=planet;
  saveAtlas();
  refreshPlanetList();
  globe.pointsData(atlas[planet]);
  refreshPointsList();
  document.getElementById("x").value="";
  document.getElementById("y").value="";
  document.getElementById("name").value="";
  document.getElementById("notes").value="";
}

function setPlanetTextureFromInput(){
  const input=document.getElementById("planetTextureInput");
  if(!input.files[0]||!currentPlanet) return;
  const reader=new FileReader();
  reader.onload=e=>{
    planetTextures[currentPlanet]=e.target.result;
    globe.globeImageUrl(planetTextures[currentPlanet]);
    saveAtlas();
  };
  reader.readAsDataURL(input.files[0]);
}

function exportAtlas(){
  const blob=new Blob([JSON.stringify({atlas,planetTextures},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="atlas.json"; a.click(); URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.atlas) atlas=data.atlas;
      if(data.planetTextures) planetTextures=data.planetTextures;
      saveAtlas(); refreshPlanetList(); alert("Import zakończony!");
    }catch(err){alert("Błąd importu JSON");}
  };
  reader.readAsText(file);
}

refreshPlanetList();
</script>
</body>
</html>
