<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Atlas Planetarny</title>
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
      overflow: hidden;
      background: #0d1b2a;
      color: #e0e6ed;
    }
    #form {
      flex: 0 0 600px;
      padding: 1rem;
      background: #1b263b;
      overflow-y: auto;
      box-sizing: border-box;
    }
    #globeViz {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      display: block;
      margin: auto;
    }
    h2 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: #f0f4f8;
    }
    label {
      font-weight: bold;
      margin-top: 0.5rem;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      margin: 0.3rem 0;
      padding: 0.4rem;
      box-sizing: border-box;
      border: none;
      border-radius: 4px;
    }
    input, select, textarea {
      background: #24344d;
      color: #f0f4f8;
    }
    button {
      background: #1976d2;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #1565c0;
    }
    .texture-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    #texturePreview {
      margin-top: 0.5rem;
      max-width: 100%;
      border-radius: 6px;
      display: none;
    }
    .grid-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .grid-control input[type="number"] {
      flex: 0 0 70px;
    }
    .grid-control input[type="range"] {
      flex: 1;
    }
    ul {
      padding: 0;
      list-style: none;
    }
    li {
      margin: 0.3rem 0;
      background: #24344d;
      padding: 0.4rem;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .point-info {
      flex: 1;
    }
    .point-actions {
      display: flex;
      gap: 0.3rem;
      justify-content: flex-end;
    }
    .point-actions button {
      width: auto;
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }
    .sort-controls {
      display: flex;
      gap: 0.5rem;
      margin: 0.5rem 0;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="form">
    <h2>Dodaj / Edytuj punkt</h2>
    <input type="hidden" id="editIndex" value="" />
    <label>Planeta</label>
    <input type="text" id="planet" placeholder="Nazwa planety" />
    <label>SzerokoÅ›Ä‡</label>
    <input type="number" id="lat" step="0.0001" />
    <label>DÅ‚ugoÅ›Ä‡</label>
    <input type="number" id="lng" step="0.0001" />
    <label>Nazwa punktu</label>
    <input type="text" id="name" />
    <label>Typ</label>
    <select id="type">
      <option>Resource</option>
      <option>Obelisk</option>
      <option>Other</option>
    </select>
    <label>Notatki</label>
    <textarea id="notes"></textarea>
    <button onclick="savePoint()">ðŸ’¾ Zapisz</button>

    <h2>Planety</h2>
    <div id="planetList"></div>

    <h2>Tekstura planety</h2>
    <div class="texture-input">
      <input type="file" id="planetTextureInput" accept="image/*" hidden />
      <button onclick="document.getElementById('planetTextureInput').click()">Wybierz plik</button>
      <button onclick="setPlanetTextureFromInput()">Ustaw</button>
    </div>
    <img id="texturePreview" />

    <h2>Siatka wspÃ³Å‚rzÄ™dnych</h2>
    <div class="grid-control">
      <input type="number" id="gridScale" value="15" min="1" max="90" step="1" oninput="syncGridInputs('number')" />
      <input type="range" id="gridScaleRange" value="15" min="1" max="90" step="1" oninput="syncGridInputs('range')" />
    </div>

    <h2>Punkty na planecie</h2>
    <div class="sort-controls">
      <label for="sortBy">Sortuj:</label>
      <select id="sortBy" onchange="refreshPointsList()">
        <option value="name">Nazwa (A-Z)</option>
        <option value="type">Typ</option>
        <option value="dateAsc">Data â†‘</option>
        <option value="dateDesc">Data â†“</option>
      </select>
    </div>
    <ul id="pointsList"></ul>

    <h2>Eksport / Import</h2>
    <button onclick="exportJSON()">ðŸ“¤ Eksportuj JSON</button>
    <input type="file" id="importFile" accept=".json" hidden onchange="importJSON(event)" />
    <button onclick="document.getElementById('importFile').click()">ðŸ“¥ Importuj JSON</button>
  </div>

  <div id="globeViz"></div>

  <script>
    let atlas = JSON.parse(localStorage.getItem("atlas") || "{}");
    let currentPlanet = null;
    let planetTextures = JSON.parse(localStorage.getItem("planetTextures") || "{}");

    const globe = Globe()(document.getElementById("globeViz"))
      .globeImageUrl(null)
      .pointLat("lat")
      .pointLng("lng")
      .pointLabel((d) =>
        `<b>${d.name || ""}</b><br>Typ: ${d.type}<br>Lat: ${d.lat.toFixed(2)}Â°, Lng: ${d.lng.toFixed(2)}Â°<br>${d.notes || ""}`
      )
      .pointColor((d) =>
        d.type === "Resource"
          ? "yellow"
          : d.type === "Obelisk"
          ? "cyan"
          : d.type === "Pole"
          ? "white"
          : "red"
      )
      .pointRadius(0.8)
      .htmlElementsData([])
      .htmlElement((d) => {
        const el = document.createElement("div");
        if (d.type === "Pole") {
          el.style.color = "white";
          el.style.fontSize = "20px";
          el.style.fontWeight = "bold";
          el.style.textShadow = "0 0 4px black";
          el.textContent = d.name.includes("PÃ³Å‚nocny") ? "N" : "S";
        }
        return el;
      });

    globe.showGraticules(true).graticuleLineWidth(0.8);
    function updateGrid() {
      const scale = parseInt(document.getElementById("gridScale").value);
      if (isNaN(scale) || scale < 1) return;
      globe.graticuleStep([scale, scale]);
    }
    function syncGridInputs(source) {
      const num = document.getElementById("gridScale");
      const range = document.getElementById("gridScaleRange");
      if (source === "number") {
        range.value = num.value;
      } else {
        num.value = range.value;
      }
      updateGrid();
    }
    updateGrid();

    function saveAtlas() {
      localStorage.setItem("atlas", JSON.stringify(atlas));
      localStorage.setItem("planetTextures", JSON.stringify(planetTextures));
    }

    function addPoles(planet) {
      if (!atlas[planet]) atlas[planet] = [];
      if (!atlas[planet].some((p) => p.type === "Pole")) {
        atlas[planet].push(
          { lat: 90, lng: 0, name: "Biegun PÃ³Å‚nocny", type: "Pole" },
          { lat: -90, lng: 0, name: "Biegun PoÅ‚udniowy", type: "Pole" }
        );
      }
    }

    function refreshPlanetList() {
      const list = document.getElementById("planetList");
      list.innerHTML = "";
      Object.keys(atlas).forEach((p) => {
        const btn = document.createElement("button");
        btn.textContent = p;
        btn.style.width = "100%";
        btn.style.margin = "0.2rem 0";
        btn.onclick = () => {
          currentPlanet = p;
          addPoles(p);
          globe.pointsData(atlas[p]);
          globe.htmlElementsData(atlas[p].filter((pt) => pt.type === "Pole"));
          setPlanetTexture(p);
          if (planetTextures[p]) {
            document.getElementById("texturePreview").src = planetTextures[p];
            document.getElementById("texturePreview").style.display = "block";
          } else {
            document.getElementById("texturePreview").style.display = "none";
          }
          refreshPointsList();
        };
        list.appendChild(btn);
      });
    }

    function refreshPointsList() {
      const list = document.getElementById("pointsList");
      list.innerHTML = "";
      if (!currentPlanet || !atlas[currentPlanet]) return;

      const sortBy = document.getElementById("sortBy").value;
      let points = [...atlas[currentPlanet]];
      if (sortBy === "name") {
        points.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      } else if (sortBy === "type") {
        points.sort((a, b) => (a.type || "").localeCompare(b.type || ""));
      } else if (sortBy === "dateAsc") {
        points.sort((a, b) => (a.created || 0) - (b.created || 0));
      } else if (sortBy === "dateDesc") {
        points.sort((a, b) => (b.created || 0) - (a.created || 0));
      }

      points.forEach((point, index) => {
        const li = document.createElement("li");

        const info = document.createElement("div");
        info.className = "point-info";
        info.textContent = `${point.name || "Bez nazwy"} (${point.type})`;

        const actions = document.createElement("div");
        actions.className = "point-actions";

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edytuj";
        editBtn.onclick = () => loadPointForEdit(index);

        const delBtn = document.createElement("button");
        delBtn.textContent = "UsuÅ„";
        delBtn.style.background = "#c62828";
        delBtn.onclick = () => {
          if (confirm("Czy na pewno usunÄ…Ä‡ ten punkt?")) {
            deletePoint(index);
          }
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        li.appendChild(info);
        li.appendChild(actions);
        list.appendChild(li);
      });
    }

    function savePoint() {
      const planet = document.getElementById("planet").value.trim();
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const name = document.getElementById("name").value.trim();
      const type = document.getElementById("type").value;
      const notes = document.getElementById("notes").value.trim();
      const editIndex = document.getElementById("editIndex").value;

      if (!planet || isNaN(lat) || isNaN(lng)) {
        alert("UzupeÅ‚nij planetÄ™, szerokoÅ›Ä‡ i dÅ‚ugoÅ›Ä‡!");
        return;
      }

      if (!atlas[planet]) atlas[planet] = [];

      if (editIndex !== "") {
        atlas[planet][editIndex] = {
          ...atlas[planet][editIndex],
          planet, lat, lng, name, type, notes
        };
        document.getElementById("editIndex").value = "";
      } else {
        atlas[planet].push({ planet, lat, lng, name, type, notes, created: Date.now() });
      }

      saveAtlas();
      currentPlanet = planet;
      refreshPlanetList();

      document.getElementById("planet").value = "";
      document.getElementById("lat").value = "";
      document.getElementById("lng").value = "";
      document.getElementById("name").value = "";
      document.getElementById("notes").value = "";
    }

    function deletePoint(index) {
      atlas[currentPlanet].splice(index, 1);
      saveAtlas();
      refreshPointsList();
      globe.pointsData(atlas[currentPlanet]);
    }

    function loadPointForEdit(index) {
      const point = atlas[currentPlanet][index];
      document.getElementById("planet").value = point.planet;
      document.getElementById("lat").value = point.lat;
      document.getElementById("lng").value = point.lng;
      document.getElementById("name").value = point.name;
      document.getElementById("type").value = point.type;
      document.getElementById("notes").value = point.notes;
      document.getElementById("editIndex").value = index;
    }

    function setPlanetTexture(planet) {
      globe.globeImageUrl(planetTextures[planet] || null);
    }
    function setPlanetTextureFromInput() {
      const input = document.getElementById("planetTextureInput");
      if (!input.files[0] || !currentPlanet) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        planetTextures[currentPlanet] = e.target.result;
        setPlanetTexture(currentPlanet);
        document.getElementById("texturePreview").src = e.target.result;
        document.getElementById("texturePreview").style.display = "block";
        saveAtlas();
      };
      reader.readAsDataURL(input.files[0]);
    }

    function exportJSON() {
      const data = { atlas, planetTextures };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "atlas.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          atlas = data.atlas || {};
          planetTextures = data.planetTextures || {};
          saveAtlas();
          refreshPlanetList();
          refreshPointsList();
        } catch {
          alert("BÅ‚Ä™dny plik JSON");
        }
      };
      reader.readAsText(file);
    }

    refreshPlanetList();
  </script>
</body>
</html>
