<!DOCTYPE html> 
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="scripts/icons.js"></script>
<script src="scripts/textures.js"></script>
<script src="scripts/points.js"></script>
<script src="scripts/galaxies.js"></script>
<script src="scripts/planetdet.js"></script>
<script src="scripts/scaling.js"></script>

<link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="form">
    <div id="tabs">
      <button class="lock-while-edit active" onclick="openTab('start')">Start</button>
      <button class="lock-while-edit" onclick="openTab('planety')">Planety</button>
      <button class="lock-while-edit" onclick="openTab('punkty')">Punkty</button>
      <button class="lock-while-edit" onclick="openTab('detale')">Detale planety</button>
    </div>
    <!-- Zak≈Çadka START -->
    <div id="start" class="tab-content active">
      <div id="noPlanetsMessage" style="color: #ffcc00; font-weight: bold; text-align: center; margin: 0.5rem 0;">
        Stw√≥rz nowƒÖ planetƒô lub importuj dane JSON
      </div>
      <h2>Dodaj punkt</h2>
      <div class="xy-inputs">
        <div>
          <label>X (‚àí90 do 90)</label>
          <input type="number" id="lat" step="1" min="-90" max="90" />
        </div>
        <div>
          <label>Y (‚àí180 do 180)</label>
          <input type="number" id="lng" step="1" min="-180" max="180" />
        </div>
      </div>
      <label>Nazwa punktu</label>
      <input type="text" id="name" />
      <label>Typ</label>
      <select id="type">
        <option>Zas√≥b</option>
        <option>Baza</option>
        <option>Ruiny</option>
        <option>Struktura</option>
        <option>Inne</option>
      </select>
      <label>Notatki</label>
      <textarea id="notes"></textarea>
      <button onclick="addPoint()">Dodaj punkt</button>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <h2>Skalowanie globu i punkt√≥w</h2>
      <!-- Suwak 1: Skalowanie punkt√≥w -->
      <label>Skalowanie punkt√≥w</label>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <input type="range" id="pointScale" min="0.1" max="1" step="0.1" value="0.4" oninput="updatePointScale()" style="flex:1;" />
        <span id="pointScaleValue" style="width:2rem; text-align:center;">0.4</span>
        <button onclick="resetPointScale()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
      </div>
      <!-- Suwak 2: Wysoko≈õƒá s≈Çupka -->
      <label>Wysoko≈õƒá s≈Çupka</label>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <input type="range" id="pointsDistanceMultiplier" min="0.5" max="30" step="0.5" value="1" oninput="updatePointsDistanceMultiplier()" style="flex:1;" />
        <span id="pointsDistanceMultiplierValue" style="width:2rem; text-align:center;">1</span>
        <button onclick="resetPointsDistanceMultiplier()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
      </div>
      <!-- Suwak 3: Zoom globu -->
      <label>Zoom globu</label>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <input type="range" id="globeZoomMultiplier" min="0.5" max="2" step="0.05" value="1" oninput="updateGlobeZoomMultiplier()" style="flex:1;" />
        <span id="globeZoomMultiplierValue" style="width:2rem; text-align:center;">1</span>
        <button onclick="resetGlobeZoomMultiplier()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
      </div>
      <!-- Autoobr√≥t -->
      <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
        <span>Obracanie globu</span>
        <input type="checkbox" id="autoRotateCheckbox" onchange="toggleAutoRotate()" />
      </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <h2>Import/Eksport</h2>
      <button class="lock-while-edit" onclick="exportAtlas()">Eksport JSON</button>
      <input class="lock-while-edit" type="file" id="importFile" accept="application/json" onchange="importAtlas(event)" />
    </div>
    <!-- Zak≈Çadka PLANETY -->
    <div id="planety" class="tab-content">
      <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
        <!-- nazwa planety -->
        <input type="text" id="newPlanetName" class="lock-while-edit" placeholder="Nazwa nowej planety" oninput="checkNewPlanetInput()" />
        <!-- label + piker -->
       	<div style="text-align:center">
          <label>  Wybierz kolor </label>
          <input type="color" id="PlanetColor" value="#000000" class="lock-while-edit" style="width:100%; height:40px;">
        </div>
        <!-- guzik tworzenia planety -->
        <button id="addPlanetBtn" class="lock-while-edit" onclick="addNewPlanet()">Stw√≥rz nowƒÖ planetƒô</button>
      </div>
      <!-- Przycisk dodaj texturƒô i zmie≈Ñ kolor -->
      <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
        <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
        <input type="text" id="planetTextureUrl" class="lock-while-edit" placeholder="URL tekstury" oninput="checkTextureInput()" />
        <div class="planet-buttons-row">
          <button id="setTextureBtn" class="lock-while-edit" onclick="addTextureUrl()">Ustaw teksturƒô</button>
          <button id="setColorBtn" class="lock-while-edit" onclick="changePlanetColor()">Zmie≈Ñ kolor</button>
        </div>
      </div>
	    <!-- Galeria miniatur -->
	  	<div id="textureGalleryContainer" class="lock-while-edit">
  		  <div id="textureGallery"></div>
  		  <div id="textureGalleryControls">
  			  <button id="prevTexturePage" onclick="changeTexturePage(-1)">‚óÄ</button>
  		  	<button id="nextTexturePage" onclick="changeTexturePage(1)">‚ñ∂</button>
		    </div>
		  </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <div class="planet-buttons-row" style="margin-bottom:1rem;">
        <button id="editSelectedPlanetBtn" onclick="editSelectedPlanet()" disabled>Zmie≈Ñ nazwƒô</button>
        <button id="deleteSelectedPlanetBtn" class="lock-while-edit" onclick="deleteSelectedPlanet()" disabled>Usu≈Ñ planetƒô</button>
      </div>
      <!-- Ukryty kontener na edycjƒô -->
      <div id="editPlanetBox" style="display:none; margin-bottom:1rem;">
        <input type="text" id="editPlanetName" placeholder="Nowa nazwa planety" style="width:100%; margin-bottom:0.5rem;">
        <div style="display:flex; gap:0.5rem;">
          <button onclick="acceptEditPlanet()">Akceptuj</button>
          <button onclick="cancelEditPlanet()">Anuluj</button>
        </div>
      </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>

		<!-- Pierwiastki planety -->
		<div id="planet-resources"></div>
		
    </div>
    <!-- Zak≈Çadka PUNKTY -->
    <div id="punkty" class="tab-content">
      <div><label>Filtruj</label></div>
      <div style="height:0.5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <div id="pointFilters">
        <label>Zas√≥b <input type="checkbox" class="pointFilter" value="Zas√≥b" checked></label>
        <label>Baza <input type="checkbox" class="pointFilter" value="Baza" checked></label>
        <label>Ruiny <input type="checkbox" class="pointFilter" value="Ruiny" checked></label>
        <label>Struktura <input type="checkbox" class="pointFilter" value="Struktura" checked></label>
        <label>Inne <input type="checkbox" class="pointFilter" value="Inne" checked></label>
        <label>Bieguny <input type="checkbox" class="pointFilter" value="Pole" checked></label>
        <label>Moja lokalizacja <input type="checkbox" class="pointFilter" value="Moja" checked></label>
      </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <label>Filtry dodatkowe</label>
      <div style="height:0.5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <div id="extraFilters">
        <label>Wydobyty <input type="checkbox" class="extraFilter" value="Wydobyty" checked></label>
        <label>Odwiedzony <input type="checkbox" class="extraFilter" value="Odwiedzony" checked></label>
        <label>Niewydobyty <input type="checkbox" class="extraFilter" value="Niewydobyty" checked></label>
        <label>Nieodwiedzony <input type="checkbox" class="extraFilter" value="Nieodwiedzony" checked></label>
      </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <label>Sortuj:</label>
      <select id="sortPoints" onchange="refreshPointsList()">
        <option value="nameAsc">Nazwa A‚ÄìZ</option>
        <option value="nameDesc">Nazwa Z‚ÄìA</option>
        <option value="type">Typ</option>
        <option value="newest">Najnowsze</option>
        <option value="oldest">Najstarsze</option>
      </select>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <ul id="pointsList"></ul>
    </div>
    <!-- Zak≈Çadka DETALE PLANETY -->
    <div id="detale" class="tab-content">
      <label>Galaktyka</label>
		<div class="galaxy-selector">
  			<input type="text" id="galaxyInput" placeholder="Wybierz galaktykƒô...">
  			<div id="galaxyDropdown" class="dropdown"></div>
	    </div>
	  <label>Uk≈Çad gwiezdy</label><input type="text" id="detailStarSystem" />
      <label>Uk≈Çad planetarny</label><input type="text" id="detailPlanetSystem" />
      <label>Biom</label>
      <select id="detailBiome">
        <option value="">-- wybierz --</option>
        <option>Bujna</option>
        <option>Ja≈Çowa</option>
        <option>Martwa</option>
        <option>Egzotyczna</option>
        <option>Mega Egzotyczna</option>
        <option>Spalona</option>
        <option>Zamro≈ºona</option>
        <option>Toksyczna</option>
        <option>Napromieniowana</option>
        <option>Bagno</option>
        <option>Wulkaniczna</option>
        <option>Gazowy Gigant</option>
      </select>
      <label>Pogoda</label>
      <select id="detailWeather">
        <option value="">-- wybierz --</option>
        <option>Brak atmosfery</option>
        <option>S≈Çonecznie</option>
        <option>Ch≈Çodno</option>
        <option>Mro≈∫no</option>
        <option>Ciep≈Ço</option>
        <option>GorƒÖco</option>
        <option>Wilgotno</option>
        <option>Deszczowo</option>
        <option>Burzowo</option>
        <option>Radioaktywne</option>
        <option>Toksyczne</option>
        <option>Kwasyczne</option>
        <option>Py≈Çowe</option>
        <option>Wulkaniczne</option>
        <option>Burze piaskowe</option>
        <option>Tornada</option>
        <option>Meteoryty</option>
        <option>Burze ogniste</option>
        <option>Wysokie ci≈õnienie</option>
        <option>Niskie ci≈õnienie</option>
        <option>Burze magnetyczne</option>
        <option>Burze elektryczne</option>
      </select>
      <label>Stra≈ºnicy</label>
      <select id="detailSentinels">
        <option value="">-- wybierz --</option>
        <option>Pasywne</option>
        <option>Brak</option>
        <option>Zrelaksowane</option>
        <option>Ograniczone</option>
        <option>Niskie</option>
        <option>Niskie bezpiecze≈Ñstwo</option>
        <option>Minimalne</option>
        <option>Aktywne</option>
        <option>≈örednie</option>
        <option>Standardowe</option>
        <option>Typowe</option>
        <option>Uwa≈ºne</option>
      </select>
      <label>Flora</label>
      <select id="detailFlora">
        <option value="">-- wybierz --</option>
        <option>Brak</option>
        <option>Sporadyczna</option>
        <option>SkƒÖpa</option>
        <option>≈örednia</option>
        <option>Obfita</option>
        <option>Ekstremalna</option>
      </select>
      <label>Fauna</label>
      <select id="detailFauna">
        <option value="">-- wybierz --</option>
        <option>Brak</option>
        <option>Sporadyczna</option>
        <option>SkƒÖpa</option>
        <option>≈örednia</option>
        <option>Obfita</option>
        <option>Ekstremalna</option>
      </select>
      <label>Odkryty przez</label><input type="text" id="detailDiscovered" />
      <label>Tryb gry</label>
      <select id="detailMode">
        <option value="">-- wybierz --</option>
        <option>Normalny</option>
        <option>Kreatywny</option>
        <option>Survival</option>
        <option>Permadeath</option>
      </select>
      <label>Zaktualizowano</label><input type="text" id="detailUpdated" />
      <label>Koordynaty</label><input type="text" id="detailCoords" />
      <!-- Przycisk przejd≈∫ do NMS Portals -->
      <button onclick="window.open('https://nmsportals.github.io', '_blank')" style="margin-top:0.5rem; background:#1976d2; color:white; padding:0.5rem; border:none; border-radius:4px; cursor:pointer;"> Przejd≈∫ do NMS Portals </button>
      <label>Notatki planety</label><textarea id="detailNotes"></textarea>
      <button onclick="savePlanetDetails()">Zapisz opis planety</button>
    </div>
  </div>
  <!-- Obszar wizualizacji globu -->
  <div id="globeWrapper" style="position: relative;">
    <!-- nag≈Ç√≥wek overlay -->
    <div id="planetOverlayHeader"></div>
    <!-- nag≈Ç√≥wek moja lokalizacja -->
    <div id="myLocationBox" style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:white; padding:0.5rem; border-radius:8px; z-index:10;">
      <div style="font-weight:bold; margin-bottom:0.5rem;">Moja lokalizacja</div>
      <label>X: <input type="number" id="myLat" step="0.01" style="width:70px;"></label>
      <label>Y: <input type="number" id="myLng" step="0.01" style="width:70px;"></label>
    </div>
    <!-- glob -->
    <div id="globeViz"></div>
    <!-- Panel z listƒÖ planet po prawej stronie -->
    
    <div id="planetSidebar">
  <h3>Lista planet</h3>
  <div id="planetListSidebar"></div>
</div>

<div id="galaxySidebar">
  <h3>Galaktyki</h3>
  <ul id="galaxyList"></ul>
</div>
    <!-- Przycisk do pokazywania/ukrywania panelu -->
   <button id="togglePlanetSidebarBtn">‚ñ∂</button>

	  <!-- Info o planecie -->
<div id="planetMiniPanel">
		  <!-- Przycisk do pokazywania/ukrywania minipanelu -->
	  <button id="toggleMiniPanelBtn">‚ñº</button>
  <div id="miniPanelBiome"></div>
  <div id="miniPanelResources"></div>
  <div id="miniPanelSentinels"></div>
</div>
	  
</div>
   
<script>
let atlas = {};
let planetDetails = {}; // szczeg√≥≈Çy ka≈ºdej planety
let planetData = []; // lista planet z dodatkowymi info
let currentPlanet = null; // aktualnie wybrana planeta
let pointScale = parseFloat(document.getElementById("pointScale").value);
let editIndex = null;
let pointsDistanceMultiplier = 1;
let globeZoomMultiplier = 1;
let autoRotate = false;
let rotateSpeed = 0.001; // prƒôdko≈õƒá obrotu w radianach na frame
let myLocationPoint = null;  
let isEditing = false; // globalna flaga
let highlightTimeout = null;
let headerLock = true; // blokada na starcie celem zablokowania mo≈ºliwo≈õci nadpisania nag≈Ç√≥wka
		
////////////////////////////////////////////////////////////////////
//----------------- Zak≈Çadki i inne elementy UI -----------------//
//////////////////////////////////////////////////////////////////// 

// Zak≈Çadki
function openTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll("#tabs button").forEach(el => el.classList.remove("active"));
  const tab = document.getElementById(tabId);
  if(tab) tab.classList.add("active");
  // oznacz odpowiedni przycisk jako active (przybli≈ºone dopasowanie)
  document.querySelectorAll("#tabs button").forEach(btn=>{
    if (btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(`'${tabId}'`)) btn.classList.add("active");
  });
updateCurrentPlanetHeader();
}
  
//zmiana nag≈Ç√≥wka z nazwƒÖ planety
function updateCurrentPlanetHeader() {
  const overlay = document.getElementById("planetOverlayHeader");
  if (!overlay) return;

  // Je≈õli blokada jest aktywna i currentPlanet jest null ‚Üí ustaw raz i zablokuj nadpisanie
  if (headerLock && !currentPlanet) {
    overlay.textContent = "Brak wybranej planety";
    return; // wychodzimy bez nadpisywania dalej
  }

  // Normalne dzia≈Çanie po starcie
  overlay.textContent = currentPlanet
    ? `${currentPlanet}`
    : "Brak wybranej planety";
}

// odblokowanie blokady po starcie (0ms po za≈Çadowaniu strony)
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    headerLock = false;
    updateCurrentPlanetHeader(); // od≈õwie≈º jeszcze raz po zdjƒôciu blokady
  }, 0);
});

function updateNoPlanetsMessage() {
  const msg = document.getElementById("noPlanetsMessage");
  const planets = Object.keys(atlas);
  if (planets.length === 0) {
    msg.style.display = "block";
  } else {
    msg.style.display = "none";
  }
  updateCurrentPlanetHeader();
}
	
// Funkcja do toggle panelu
function togglePlanetSidebar() {
  const sidebar = document.getElementById("planetSidebar");
  const galaxySidebar = document.getElementById("galaxySidebar"); // panel galaktyk
  const btn = document.getElementById("togglePlanetSidebarBtn");

  sidebar.classList.toggle("hidden");
  galaxySidebar.classList.toggle("hidden");

  if (sidebar.classList.contains("hidden")) {
    btn.textContent = "‚óÄ"; // panel ukryty ‚Üí strza≈Çka w prawo
  } else {
    btn.textContent = "‚ñ∂"; // panel widoczny ‚Üí strza≈Çka w lewo
    refreshPlanetSidebar();
	refreshGalaxySidebar();
  }
}

// Pod≈ÇƒÖcz przycisk
document.getElementById("togglePlanetSidebarBtn").addEventListener("click", togglePlanetSidebar);

	
// Mini panel z inofo o planecie
function updatePlanetMiniPanel() {
  const panel = document.getElementById("planetMiniPanel");
  if (!panel || !currentPlanet) return;

	// blokada: je≈õli panel jest ukryty, to nic nie r√≥b
  if (panel.classList.contains("hidden")) return;
	
 // reset zawarto≈õci panelu
const contentEls = panel.querySelectorAll("div:not(:first-child)");
  contentEls.forEach(el => el.remove());

  const details = planetDetails[currentPlanet] || {};
 
  // USTAWIENIA GLOBALNE dla minipanelu
  const ICON_SIZE = 40;   // x2 (wcze≈õniej by≈Ço 20px)
  const FONT_SIZE = "18px"; // x2 (wcze≈õniej ~9px)
 
	// === BIOM (ikona + tekst) ===
  const biomeRow = document.createElement("div");
  biomeRow.style.display = "flex";
  biomeRow.style.alignItems = "center";
  biomeRow.style.gap = "2px";
	
  const biomeIcon = icons.find(i => i.type === "UI" && i.name === "Planet");
  if (biomeIcon) {
    const img = document.createElement("img");
    img.src = biomeIcon.icon;
    img.alt = "Biom";
    img.style.width = ICON_SIZE + "px";
    img.style.height = ICON_SIZE + "px";
    biomeRow.appendChild(img);
  }

  const biomeText = document.createElement("span");
  biomeText.textContent = details.biome || "Nieznany biom";
  biomeRow.appendChild(biomeText);

  panel.appendChild(biomeRow);

  // stra≈ºnicy -> ikona + opis
  const sentinelsRow = document.createElement("div");
  sentinelsRow.style.display = "flex";
  sentinelsRow.style.alignItems = "center";
  sentinelsRow.style.gap = "2px";
	 
  const sentinelIcon = icons.find(i => i.type === "UI" && i.name === "Sentinel");
  if (sentinelIcon) {
    const img = document.createElement("img");
    img.src = sentinelIcon.icon;
    img.alt = "Sentinel";
    img.style.width = ICON_SIZE + "px";
    img.style.height = ICON_SIZE + "px";
    sentinelsRow.appendChild(img);
  }

  const sentinelsText = document.createElement("span");
  sentinelsText.textContent = details.sentinels || "Nieznani stra≈ºnicy";
  sentinelsRow.appendChild(sentinelsText);

  panel.appendChild(sentinelsRow);

  // kontener na pierwiastki
  const resourcesContainer = document.createElement("div");
  resourcesContainer.style.display = "flex";
  resourcesContainer.style.flexDirection = "column";
  resourcesContainer.style.gap = "1px";
	

  const resources = details.resources || [];
  const resourceIcons = icons.filter(i => i.type === "resource");
  resources.forEach(resName => {
    const resObj = icons.find(r => r.name === resName);
    if (!resObj) return;

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "2px";

    const img = document.createElement("img");
    img.src = resObj.icon;
    img.alt = resObj.name;
    img.style.width = ICON_SIZE + "px";
    img.style.height = ICON_SIZE + "px";

    const label = document.createElement("span");
    label.textContent = resObj.name;

    row.appendChild(img);
    row.appendChild(label);
    resourcesContainer.appendChild(row);
  });

  panel.appendChild(resourcesContainer);
}

	// Funkcja do toggle mini panelu
function toggleMiniPanel() {
  const miniPanel = document.getElementById("planetMiniPanel");
  const btn = document.getElementById("toggleMiniPanelBtn");

  miniPanel.classList.toggle("hidden");

  if (miniPanel.classList.contains("hidden")) {
    btn.textContent = "‚ñ≤"; // panel ukryty ‚Üí strza≈Çka w g√≥rƒô
  } else {
    btn.textContent = "‚ñº"; // panel widoczny ‚Üí strza≈Çka w d√≥≈Ç
    updatePlanetMiniPanel();
  }
}

// Pod≈ÇƒÖcz przycisk
document.getElementById("toggleMiniPanelBtn").addEventListener("click", toggleMiniPanel);

////////////////////////////////////////////////////////////////////
//------------------ Punkty -------------------//
//////////////////////////////////////////////////////////////////// 

// Ograniczenie zakres√≥w imput√≥w X I Y
const latInput = document.getElementById("lat");
const lngInput = document.getElementById("lng");

function clampLatLng() {
  let lat = parseFloat(latInput.value);
  let lng = parseFloat(lngInput.value);

  if (!isNaN(lat)) {
    if (lat < -90) lat = -90;
    if (lat > 90) lat = 90;
    latInput.value = lat;
  }

  if (!isNaN(lng)) {
    if (lng < -180) lng = -180;
    if (lng > 180) lng = 180;
    lngInput.value = lng;
  }
}

// Nas≈Çuchiwanie zmiany warto≈õci
latInput.addEventListener("input", clampLatLng);
lngInput.addEventListener("input", clampLatLng);

// Funkcja tworzƒÖca teksturƒô z gwiazdkƒÖ
function createStarTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 64;
    canvas.height = 64;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '48px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = 'yellow'; // kolor gwiazdki
    ctx.fillText('‚≠ê', canvas.width/2, canvas.height/2);
    const texture = new THREE.CanvasTexture(canvas);
    return texture;
}

 function updateMyLocation() {
  const lat = parseFloat(document.getElementById("myLat").value);
  const lng = parseFloat(document.getElementById("myLng").value);

  if (isNaN(lat) || isNaN(lng)) {
    myLocationPoint = null;
  } else {
    myLocationPoint = { 
      lat, 
      lng, 
      altitude: 0.02, 
      type: "Moja", 
     };
  }

  refreshGlobePoints(); // rysujemy razem z resztƒÖ
}

document.getElementById("myLat").addEventListener("input", updateMyLocation);
document.getElementById("myLng").addEventListener("input", updateMyLocation);

// Ograniczenie zakresu dla mojej lokalizacji
const myLatInput = document.getElementById("myLat");
const myLngInput = document.getElementById("myLng");

function clampMyLatLng() {
  let lat = parseFloat(myLatInput.value);
  let lng = parseFloat(myLngInput.value);

  if (!isNaN(lat)) {
    if (lat < -90) lat = -90;
    if (lat > 90) lat = 90;
    myLatInput.value = lat;
  }

  if (!isNaN(lng)) {
    if (lng < -180) lng = -180;
    if (lng > 180) lng = 180;
    myLngInput.value = lng;
  }
}

myLatInput.addEventListener("input", clampMyLatLng);
myLngInput.addEventListener("input", clampMyLatLng);

	
////////////////////////////////////////////////////////////////////
//------------------ Planety, lista, tworzenie -------------------//
//////////////////////////////////////////////////////////////////// 
  
// Dodawanie nowych planet
  function checkNewPlanetInput() {
  const input = document.getElementById("newPlanetName");
  const button = document.getElementById("addPlanetBtn");
  button.disabled = input.value.trim() === "";
}
// Po za≈Çadowaniu DOM od razu sprawdzamy input i ustawiamy stan przycisku
document.addEventListener("DOMContentLoaded", () => {
  checkNewPlanetInput(); // ustawia disabled zgodnie z zawarto≈õciƒÖ input
});
    
function addNewPlanet() {
  const input = document.getElementById("newPlanetName");
  const name = input.value.trim();
  if (!name) return;

  if (atlas[name]) {
    alert("Planeta ju≈º istnieje!");
    return;
  }

  // wyb√≥r koloru
  const colorHex = document.getElementById("PlanetColor").value || "#000000";
  const textureBase64 = hexToBase64Texture(colorHex);
  
  atlas[name] = [];
  addPoles(name);
  
  // Dodaj pustƒÖ strukturƒô detali od razu:
  planetDetails[name] = {
    galaxy: currentGalaxy,
    starSystem: "",
    planetSystem: "",
    resources: [],
	biome: "",
    weather: "",
    sentinels: "",
    flora: "",
    fauna: "",
    discovered: "",
    mode: "",
    updated: "",
    coords: "",
    notes: ""
  };
  // Dodanie nowego wpisu do planetData
  planetData.push({
    name: name,
    texture: textureBase64,  // Przypisanie koloru planety w formie tekstury
    extraInfo: {}, // miejsce na dodatkowe, niestandardowe dane planety
    createdAt: Date.now() //automatycznie zapisany czas dodania planety
  });
  currentPlanet = name;
  updateCurrentPlanetHeader();
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();
  updateSelectedPlanetButtons();
  refreshPlanetSidebar();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel()
	
  
    // Ustaw od razu glob na wybranƒÖ teksturƒô
  globe.globeImageUrl(textureBase64);
  
    input.value = "";
  checkNewPlanetInput();
  alert(`Dodano nowƒÖ planetƒô: ${name}`);
  updateNoPlanetsMessage()
}


	
// Lista planet
// Zwraca dane do renderowania ‚Äì tylko sortowanie i grupowanie
function getGroupedPlanets() {
  const createdAtMap = {};
  (planetData || []).forEach(pd => {
    if (pd && pd.name) createdAtMap[pd.name] = pd.createdAt || 0;
  });

  const structure = { "Nieznany": { "Nieznany": [] } };

  Object.keys(atlas).forEach(p => {
    const starSystem = (planetDetails[p]?.starSystem || "").trim() || "Nieznany";
    const planetSystem = (planetDetails[p]?.planetSystem || "").trim() || "Nieznany";

    if (!structure[starSystem]) structure[starSystem] = {};
    if (!structure[starSystem][planetSystem]) structure[starSystem][planetSystem] = [];
    structure[starSystem][planetSystem].push(p);
  });

  // Sortowanie wg daty utworzenia (zagnie≈ºd≈ºone)
  const INF = Number.MAX_SAFE_INTEGER;

  const sortedstarSystems = Object.keys(structure).sort((a, b) => {
    if (a === "Nieznany") return -1;
    if (b === "Nieznany") return 1;
    return a.localeCompare(b);
  });

  return sortedstarSystems.map(starSystem => {
    const planetSystemsObj = structure[starSystem];
    const sortedplanetSystems = Object.keys(planetSystemsObj).sort((a, b) => {
      if (a === "Nieznany") return -1;
      if (b === "Nieznany") return 1;
      return a.localeCompare(b);
    });
//Zwracamy gotowƒÖ strukturƒô do wyrenderowania
    return {
      starSystem,
      planetSystems: sortedplanetSystems.map(sys => ({
        name: sys,
        planets: planetSystemsObj[sys].sort((p1, p2) =>
          (createdAtMap[p1] || INF) - (createdAtMap[p2] || INF)
        )
      }))
    };
  });
}

// Renderowanie list planet na wizualizacji globu
function refreshPlanetSidebar() {
  const sidebar = document.getElementById("planetSidebar");
  if (!sidebar) return;

  // Je≈õli panel jest ukryty, nic nie r√≥b aby nie blokowaƒá poka≈º / ukryj listy planet
  if (sidebar.classList.contains("hidden")) return;

  if (!atlas) return;

  const listContainer = document.getElementById("planetListSidebar");
  if (!listContainer) return;
  listContainer.innerHTML = ""; // WA≈ªNE: czy≈õcimy listƒô przed ponownym renderowaniem

  const grouped = getGroupedPlanets(); // zachowuje uk≈Çady gwiezdne i systemy planetarne

  grouped.forEach(starGroup => {
    // filtrujemy ca≈Çe uk≈Çady gwiezdne wg wybranej galaktyki
    const hasPlanetsInGalaxy = starGroup.planetSystems.some(sys =>
      sys.planets.some(planetName => {
        if (!currentGalaxy) return true; // je≈õli nic nie wybrano, poka≈º wszystkie
        return planetDetails[planetName]?.galaxy === currentGalaxy;
      })
    );

    if (!hasPlanetsInGalaxy) return; // pomi≈Ñ uk≈Çad gwiezdny, je≈õli w tej galaktyce brak planet

    // nag≈Ç√≥wek uk≈Çadu gwiezdnego
    const starHeader = document.createElement("h3");
    starHeader.textContent = starGroup.starSystem === "Nieznany"
  ? "Nieznany uk≈Çad gwiezdny"
  : starGroup.starSystem;
	starHeader.style.fontSize = "0.9rem";
    starHeader.style.margin = "0.8rem 0 0.4rem";
    starHeader.style.color = starGroup.starSystem === "Nieznany" ? "#aaa" : "#ffcc00";
    listContainer.appendChild(starHeader);

    // teraz iteracja po systemach planetarnych wewnƒÖtrz tego uk≈Çadu gwiezdnego
    starGroup.planetSystems.forEach(planetSystem => {
      // filtrujemy planety tego systemu wg planetDetails (GALAKTYKA)
      const planetsInGalaxy = planetSystem.planets.filter(planetName => {
        if (!currentGalaxy) return true; // je≈õli nic nie wybrano, poka≈º wszystkie
        return planetDetails[planetName]?.galaxy === currentGalaxy;
      });

      if (planetsInGalaxy.length === 0) return; // pomi≈Ñ system, je≈õli nie ma pasujƒÖcych planet

      // nag≈Ç√≥wek systemu
		const header = document.createElement("h4");
		header.textContent = planetSystem.name === "Nieznany"
		  ? "Nieznany uk≈Çad planetarny"
		  : planetSystem.name;
		header.style.fontSize = "0.9rem";
		header.style.margin = "0.5rem 0";
		header.style.color = planetSystem.name === "Nieznany" ? "#aaa" : "#ffcc00";
		
		// WY≈öRODKUJ tylko je≈õli to "Nieznany uk≈Çad planetarny"
		if (planetSystem.name === "Nieznany") {
		  header.style.textAlign = "center";
		}
		
		listContainer.appendChild(header);

      // planety w systemie (ju≈º przefiltrowane)
      planetsInGalaxy.forEach(planetName => {
        const li = document.createElement("li");
        li.style.cursor = "pointer";
        li.style.padding = "2px 0";
        li.textContent = planetName;

        // pod≈õwietlenie wybranej planety
        if (planetName === currentPlanet) {
          li.style.fontWeight = "bold";
          li.style.color = "#1976d2";
        }

        li.onclick = () => {
          currentPlanet = planetName;
          updateCurrentPlanetHeader();
          addPoles(planetName);
          refreshGlobePoints();
          globe.htmlElementsData(atlas[planetName].filter(pt => pt.type === "Pole"));
          refreshPointsList();
          selectPlanet(planetName);
          updateSelectedPlanetButtons();
          refreshPlanetSidebar(); // od≈õwie≈ºamy sidebar, ≈ºeby pod≈õwietlenie dzia≈Ça≈Ço
          loadPlanetDetails();
			renderPlanetResourcesPanel();
			updatePlanetMiniPanel();
        };

        listContainer.appendChild(li);
      });
    });
  });
}

	
// Renderuje nag≈Ç√≥wki i planety (obecnie niewykorzystane)
  
function refreshPlanetList() {
  const list = document.getElementById("planetList");
  if (!list) return;

  list.innerHTML = "";
  const grouped = getGroupedPlanets();

  const frag = document.createDocumentFragment();

  grouped.forEach(starGroup => {
    const starHeader = document.createElement("h2");
    starHeader.textContent = starGroup.starSystem === "Nieznany"
  ? "Nieznany uk≈Çad gwiezdny"
  : starGroup.starSystem;
    starHeader.style.color = starGroup.starSystem === "Nieznany" ? "#aaa" : "#ffcc00";
    frag.appendChild(starHeader);

   starGroup.planetSystems.forEach(planetSystem => {
      const header = document.createElement("h3");
      header.textContent = planetSystem.name === "Nieznany"
        ? "Nieznany uk≈Çad planetarny"
        : planetSystem.name;
      header.style.color = planetSystem.name === "Nieznany" ? "#aaa" : "#ffcc00";

      // WY≈öRODKUJ tylko je≈õli to "Nieznany uk≈Çad planetarny"
      if (planetSystem.name === "Nieznany") {
        header.style.textAlign = "center";
      }

      frag.appendChild(header);

      planetSystem.planets.forEach(p => {
        frag.appendChild(renderPlanetRow(p));
      });
    });
  });

  list.appendChild(frag);
  updateNoPlanetsMessage();
}

// Tworzy pojedynczy wiersz
function renderPlanetRow(p) {
  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.alignItems = "center";
  container.style.margin = "0.2rem 0";

  const btn = document.createElement("button");
  btn.textContent = p;
  btn.style.flex = "1";
  btn.style.marginRight = "0.5rem";
  btn.style.background = "#e5e5e5";
  btn.style.color = "black";
  btn.style.border = "none";
  btn.style.padding = "0.3rem";
  btn.style.borderRadius = "4px";
  btn.style.cursor = "pointer";

// Pod≈õwietlanie wybranej planety
  if (p === currentPlanet) {
    btn.style.background = "#1976d2";  // niebieski
    btn.style.color = "white";
    btn.style.fontWeight = "bold";
  }
  
  btn.onclick = () => {
    if (isEditing) return; // blokada w trybie edycji
    currentPlanet = p;
    updateCurrentPlanetHeader();
    addPoles(p);
    refreshGlobePoints();
    globe.htmlElementsData(atlas[p].filter(pt => pt.type === "Pole"));
    refreshPointsList();
    loadPlanetDetails();
    selectPlanet(p);
    updateSelectedPlanetButtons();
    refreshPlanetList(); // <-- od≈õwie≈º listƒô, ≈ºeby prze≈ÇƒÖczyƒá pod≈õwietlenie
	  renderPlanetResourcesPanel();
	  updatePlanetMiniPanel();
  };

  container.appendChild(btn);
  return container;
}
  
 // Funkcja pomocnicza do aktualizacji planetData
function updatePlanetData(name, extra = {}) {
  const idx = planetData.findIndex(pd => pd.name === name);
  if (idx !== -1) {
    // aktualizacja istniejƒÖcego wpisu
    planetData[idx].extraInfo = {...planetData[idx].extraInfo, ...extra};
  } else {
    // je≈õli planeta nie istnieje, dodaj nowƒÖ
    planetData.push({
      name: name,
      extraInfo: extra,
      createdAt: Date.now()
    });
  }
}
//Jest to uniwersalna funkcja updatePlanetData, kt√≥ra utrzymuje sp√≥jno≈õƒá tablicy planetData;
//Mo≈ºna ≈Çatwo dodawaƒá dodatkowe informacje do planet, bez zmieniania istniejƒÖcych struktur atlas i planetDetails;
//Nie zmienia siƒô istniejƒÖcy mechanizm dodawania, edycji ani usuwania planet ‚Äì wszystko jest kompatybilne.

// Funkcja aktualizujƒÖca stan przycisk√≥w w zale≈ºno≈õci od tego, czy planeta jest zaznaczona
function updateSelectedPlanetButtons() {
  const editBtn = document.getElementById("editSelectedPlanetBtn");
  const delBtn  = document.getElementById("deleteSelectedPlanetBtn");
  const enabled = !!currentPlanet;
  editBtn.disabled = !enabled;
  delBtn.disabled = !enabled;
}

// Edycja zaznaczonej planety
function editSelectedPlanet() {
  if (!currentPlanet) {
    alert("Najpierw zaznacz planetƒô.");
    return;
  }
  isEditing = true;
  setButtonsDisabled(true);
  
const box = document.getElementById("editPlanetBox");
  const input = document.getElementById("editPlanetName");

  // wstawiamy aktualnƒÖ nazwƒô planety
  input.value = currentPlanet;

  // pokazujemy placeholder z edycjƒÖ
  box.style.display = "flex";
  box.style.gap = "0.5rem"; // ≈ºeby input i przyciski by≈Çy ≈Çadnie obok siebie
  input.focus();

  // wy≈ÇƒÖcz inne przyciski
  setButtonsDisabled(true);
  }

// Wywo≈Çujemy po ka≈ºdej zmianie zaznaczenia planety
function selectPlanet(name) {
  const planet = planetData.find(p => p.name === name);
  if (!planet) return;
  currentPlanet = planet.name;
  updateCurrentPlanetHeader();
  globe.globeImageUrl(planet.texture || blackTextureURL);
  updateSelectedPlanetButtons();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel();
	refreshPlanetSidebar();
	refreshPointsList();
	refreshGlobePoints();
}
	
// Zatwierdzenie edycji
function acceptEditPlanet() {
  const newName = document.getElementById("editPlanetName").value.trim();

  if (!newName) {
    alert("Podaj nowƒÖ nazwƒô planety.");
    return;
  }

  // Je≈õli nazwa siƒô zmieni≈Ça i ju≈º istnieje, blokujemy
  if (newName !== currentPlanet && atlas[newName]) {
    alert("Planeta o tej nazwie ju≈º istnieje!");
    return;
  }

  // Tylko je≈õli zmieniamy nazwƒô faktycznie
  if (newName !== currentPlanet) {
    atlas[newName] = atlas[currentPlanet];
    delete atlas[currentPlanet];

    planetDetails[newName] = planetDetails[currentPlanet] || {};
    delete planetDetails[currentPlanet];

    const idx = planetData.findIndex(p => p.name === currentPlanet);
    if (idx !== -1) planetData[idx].name = newName;

    currentPlanet = newName; // ustawiamy nowƒÖ nazwƒô jako aktywnƒÖ
  }

  refreshPlanetList();
  updateCurrentPlanetHeader();
  updateSelectedPlanetButtons();
  refreshPlanetSidebar();
  document.getElementById("editPlanetBox").style.display = "none";
  setButtonsDisabled(false);
  isEditing = false;
  setButtonsDisabled(false);
  checkNewPlanetInput();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel();
}

  function cancelEditPlanet() {
  // Ukryj box edycji
  document.getElementById("editPlanetBox").style.display = "none";

  // Odblokuj przyciski
  setButtonsDisabled(false);

  // Zako≈Ñcz tryb edycji
  isEditing = false;

  // Sprawd≈∫ input nowej planety, ≈ºeby przycisk "Dodaj nowƒÖ planetƒô" mia≈Ç poprawny stan
  checkNewPlanetInput();
}
  
// Usuniƒôcie zaznaczonej planety z potwierdzeniem
function deleteSelectedPlanet() {
  if (!currentPlanet) return;
  if (!confirm(`Czy na pewno usunƒÖƒá planetƒô "${currentPlanet}" wraz ze wszystkimi punktami?`)) return;

  delete atlas[currentPlanet];
  delete planetDetails[currentPlanet];
  const idx = planetData.findIndex(p => p.name === currentPlanet);
  if (idx !== -1) planetData.splice(idx, 1);

  const planets = Object.keys(atlas);
  currentPlanet = planets.length ? planets[0] : null;

   if (currentPlanet) {
    selectPlanet(currentPlanet); // ustawia od razu poprawnƒÖ teksturƒô globu
  } else {
    globe.globeImageUrl(blackTextureURL); // brak planet ‚Üí czarny glob
  }
  
  updateCurrentPlanetHeader();
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();
  updateSelectedPlanetButtons();
  refreshPlanetSidebar();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel();
}

// Wywo≈Çanie przy starcie, ≈ºeby przyciski by≈Çy poprawnie wyszarzone je≈õli brak planet
updateSelectedPlanetButtons();

// Funkcja pomocnicza (w≈ÇƒÖcz/wy≈ÇƒÖcz przycisk
function setButtonsDisabled(disabled) {
  document.querySelectorAll(".lock-while-edit").forEach(btn => {
    btn.disabled = disabled;
  });
}

// Galaktyki
function updateDefaultGalaxy(galaxy) {
  defaultGalaxy = galaxy || "Euclid";
  if (currentPlanet && planetDetails[currentPlanet]) {
    planetDetails[currentPlanet].galaxy = defaultGalaxy;
  }
}


// ustaw domy≈õlnƒÖ galaktykƒô w input na starcie.	
document.addEventListener("DOMContentLoaded", () => {
  const g = document.getElementById("galaxyInput");
  if (g) g.value = currentGalaxy;
  refreshGalaxySidebar();
	renderPlanetResourcesPanel();
});

// Renderowanie listy checkbox√≥w pierwiastk√≥w dla wybranej planety
function renderPlanetResourcesPanel() {
  const container = document.getElementById("planet-resources");
  if (!container) return;

  container.innerHTML = "";
 
  // Grid 6 kolumn (ikona, checkbox, nazwa √ó2)
  const grid = document.createElement("div");
  grid.style.display = "grid";
  grid.style.gridTemplateColumns = "40px 20px auto 40px 20px auto";
  grid.style.gridGap = "4px";
  grid.style.alignItems = "center";
  container.appendChild(grid);
  
	// filtrujemy tylko ikony typu "resource"
  icons.filter(res => res.type === "resource")
    .forEach(res => {
    // Ikona pierwiastka
    const img = document.createElement("img");
    img.src = res.icon;
    img.alt = res.name;
    img.style.width = "40px";
    img.style.height = "40px";
    grid.appendChild(img);

    // Checkbox pierwiastka
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.disabled = !currentPlanet; // aktywny tylko je≈õli planeta jest wybrana

    // przechowujemy w dataset nazwƒô pierwiastka
    checkbox.dataset.resource = res.name;

    // ustawiamy stan checkboxa je≈õli planeta istnieje
    if (currentPlanet && planetDetails[currentPlanet]?.resources?.includes(res.name)) {
      checkbox.checked = true;
    }

    // obs≈Çuga zmiany stanu
    checkbox.addEventListener("change", () => {
      if (!currentPlanet) return;

      if (!planetDetails[currentPlanet]) planetDetails[currentPlanet] = { resources: [] };
      const arr = planetDetails[currentPlanet].resources;

      if (checkbox.checked) {
        if (!arr.includes(res.name)) arr.push(res.name);
      } else {
        planetDetails[currentPlanet].resources = arr.filter(r => r !== res.name);
      }
	updatePlanetMiniPanel();
    });

    grid.appendChild(checkbox);

    // Nazwa pierwiastka
    const nameLabel = document.createElement("span");
    nameLabel.textContent = res.name;
    nameLabel.style.textAlign = "left";
    grid.appendChild(nameLabel);
  });
}
////////////////////////////////////////////////////////////////////
//---------------- Eksport / Import Atlasu ---------------//
////////////////////////////////////////////////////////////////////  

function exportAtlas(){
  const blob = new Blob([JSON.stringify({
    atlas,
    planetDetails,
    planetData,
    textures // dodajemy listƒô galerii do JSON
  }, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      if(data.atlas) atlas = data.atlas;
      if(data.planetDetails) planetDetails = data.planetDetails;
      if(data.planetData) planetData = data.planetData;
      if(data.textures) {
        textures.length = 0;
        textures.push(...data.textures);
        currentTexturePage = 0;
        renderTexturePage();
      }

      const planets = Object.keys(atlas);
      currentPlanet = planets[0] || null;

      if (currentPlanet) {
        
        selectPlanet(currentPlanet);
      } else {
        globe.globeImageUrl(blackTextureURL);
        updateNoPlanetsMessage();
      }

      alert("Import zako≈Ñczony!");
    } catch(err){ 
      console.error(err);
      alert("B≈ÇƒÖd importu JSON"); 
    }
  };
  reader.readAsText(file);
}
  
////////////////////////////////////////////////////////////////////
//---------------------- Inicjalizacja globu ---------------------//
//////////////////////////////////////////////////////////////////// 
  
  // Tworzymy czarnƒÖ teksturƒô globalnie, kt√≥ra zastƒÖpi globeImageUrl(null). 
  // Podczas tworzenia planet, je≈õli od razu nie przypisywali≈õmy tekstury i pozstawiali≈õmy pusty glob
  // to generowa≈Ço to b≈Çƒôdy podczas prze≈ÇƒÖczania siƒô miƒôdzy planetami na li≈õcie planet - nie wy≈õwietla≈Ço poprawnie globu. 
  
  const blackTextureURL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";

  
  // Inicjalizacja globu ‚Äî u≈ºywamy https aby t≈Ço zawsze siƒô za≈Çadowa≈Ço
const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null) // brak domy≈õlnej mapy (pusta/ciemna kula)
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png') // üåå gwiazdy w tle

  .pointLat("lat")
  .pointLng("lng")
  .pointLabel(d => {
    // zabezpieczenie: gdy nie ma currentPlanet, zwracamy opis punktu pojedynczo
    if (!currentPlanet || !atlas[currentPlanet]) {
    let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
    if (d.type === "Zas√≥b") label += d.extracted ? " [Wydobyty]" : " [Niewydobyty]";
    if (["Ruiny","Struktura","Inne"].includes(d.type)) label += d.visited ? " [Odwiedzony]" : " [Nieodwiedzony]";
    return label;
  }

    // grupowanie punkt√≥w w tym samym miejscu dla aktualnej planety
     const sameLocation = atlas[currentPlanet].filter(p => p.lat === d.lat && p.lng === d.lng);
      if (sameLocation.length > 1) {
        return sameLocation.map(p => {
          let label = `${p.name || "Bez nazwy"} (${p.type})`;
          if (p.type === "Zas√≥b") label += p.extracted ? " [Wydobyty]" : " [Niewydobyty]";
          if (["Ruiny","Struktura","Inne"].includes(p.type)) label += p.visited ? " [Odwiedzony]" : " [Nieodwiedzony]";
          return label;
        }).join("<br>");
      }

      let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
      if (d.type === "Zas√≥b") label += d.extracted ? " [Wydobyty]" : " [Niewydobyty]";
      if (["Ruiny","Struktura","Inne"].includes(d.type)) label += d.visited ? " [Odwiedzony]" : " [Nieodwiedzony]";
      return label;
    })
  .pointColor(d => {
  if (d && d.__highlight) return "orange";   // zawsze najpierw sprawd≈∫ highlight
                                             // wtedy nie trzeba nadpisywaƒá pointColor w show i highlight bƒôdzie dzia≈Çaƒá zawsze, przy ka≈ºdym od≈õwie≈ºeniu.
  switch (d.type) {
    case "Zas√≥b":     return d.extracted ? "gray" : "gold";
    case "Baza":      return "blue";
    case "Ruiny":     return d.visited ? "lime" : "orange";
    case "Struktura": return d.visited ? "cyan" : "magenta";
    case "Inne":      return d.visited ? "purple" : "brown";
    case "Pole":      return "red";
    default:          return "red";
  }
})
  .pointRadius(() => pointScale)
  .htmlElementsData([])
  .htmlElement(d=>{
    if(d.type==="Pole"){
      const el=document.createElement("div");
      el.style.color="white";
      el.style.fontSize="20px";
      el.style.fontWeight="bold";
      el.style.textShadow="0 0 4px black";
      el.textContent=d.name==="Biegun P√≥≈Çnocny"?"N":"S";
      return el;
    }
    if (d.type === "Moja") {
      const el = document.createElement("div");
      el.style.color = "yellow";
      el.style.fontSize = "22px";
      el.style.fontWeight = "bold";
      el.style.textShadow = "0 0 6px black";
      el.textContent = "‚≠ê";
      return el;
    }
  });

// ustawienie punkt√≥w dla aktualnej planety
if (currentPlanet && atlas[currentPlanet]) {
  globe.pointsData(atlas[currentPlanet]);
  globe.htmlElementsData(atlas[currentPlanet].filter(p => p.type === "Pole"));
}
//Nas≈Çuchiwacze dla filtr√≥w typ√≥w i dodatkowych
  // Checkboxy typ√≥w punkt√≥w
document.querySelectorAll(".pointFilter").forEach(cb => {
    cb.addEventListener("change", () => {
        refreshPointsList();
        refreshGlobePoints();
    });
});

// Checkboxy dodatkowe (Wydobyty/Niewydobyty/Odwiedzony/Nieodwiedzony)
document.querySelectorAll(".extraFilter").forEach(cb => {
    cb.addEventListener("change", () => {
        refreshPointsList();
        refreshGlobePoints();
    });
});

  //Nas≈Çuchiwacz dla sortowania
  const sortSelect = document.getElementById("sortPoints");
if(sortSelect) {
    sortSelect.addEventListener("change", () => {
        refreshPointsList();
    });
}

// inicjalizacja przycisk√≥w przewijania minigalerii na starcie
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('prevTexturePage').disabled = true;
  document.getElementById('nextTexturePage').disabled = true;
  });
  
globe.showGraticules(true).graticuleLineWidth(0.5);
	
// start
window.onload = () => {
  openTab("start"); // aktywuj pierwszƒÖ zak≈Çadkƒô
  refreshPlanetList();
  refreshPointsList();
  updateNoPlanetsMessage();
  checkNewPlanetInput();
  updateCurrentPlanetHeader();
  }
 	
</script>
</body>
</html>
