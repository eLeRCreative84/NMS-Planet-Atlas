  <!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; overflow: hidden; font-size: 14px; }
  #form { flex: 0 0 25%; min-width: 280px; max-width: 450px; padding: 1rem; background: #0a1e3a; color: white; overflow-y: auto; box-sizing: border-box; }
  #globeViz { flex: 1; background: black; position: relative; }
  /* upewniamy się że canvas zajmuje cały obszar kontenera */
  #globeViz canvas { width: 100% !important; height: 100% !important; display: block; background: transparent; }

  h2 { margin-top: 1rem; margin-bottom: 0.5rem; }
  input, select, textarea, button { width: 100%; margin: 0.3rem 0; padding: 0.4rem; box-sizing: border-box; }
  button { cursor: pointer; }
  .texture-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .texture-input button { flex: 1; padding: 0.5rem; border: none; background: #1976d2; color: white; border-radius: 4px; }
  .texture-input button:hover { background: #1565c0; }
  ul { padding: 0; list-style: none; }
  li { margin: 0.3rem 0; background: #1a2b4d; padding: 0.3rem; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  li div { display: flex; gap: 0.5rem; align-items: center; }
  li button { padding: 0.2rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; }
  li button.edit { background: #0277bd; color: white; }
  li button.del { background: #c62828; color: white; }
  label { display: block; margin-top: 0.5rem; font-weight: bold; }
  .xy-inputs { display: flex; gap: 0.3rem; }
  .xy-inputs input { width: 50%; }

  #tabs { display: flex; background: #102b56; margin-bottom: 0.5rem; }
  #tabs button { flex: 1; padding: 0.5rem; border: none; background: #102b56; color: white; cursor: pointer; font-weight: bold; }
  #tabs button.active { background: #1976d2; }
  .tab-content { display: none; padding: 1rem 0 0 0; overflow-y: auto; }
  .tab-content.active { display: block; }

/* Nagłówek aktualnej planety */
.currentPlanetHeader {
  margin: 0.2rem 0 0.5rem 0;
  font-size: 1.2rem;
  font-weight: bold;
  text-align: center;
  background-color: #1a3a6a; /* jasny granat, pasuje do zakładek */
  padding: 0.3rem 0;
  border-radius: 4px;
  color: white;
}

/* Pola współrzędnych X i Y */
.xy-inputs {
  display: flex;
  gap: 1cm; /* większy odstęp między polami */
}
.xy-inputs div {
  display: flex;
  flex-direction: column;
  width: max-content; /* szerokość dopasowana do napisu */
}

.xy-inputs input {
  width: 100%; /* dopasowuje się do szerokości rodzica */
}

.tab-content h2 {
  text-align: center;
}
 
</style>
</head>
<body>
<div id="form">
  <div id="tabs">
    <button class="active" onclick="openTab('start')">Start</button>
    <button onclick="openTab('planety')">Planety</button>
    <button onclick="openTab('punkty')">Punkty</button>
    <button onclick="openTab('detale')">Detale planety</button>
  </div>

  <!-- Zakładka START -->
  <div id="start" class="tab-content active">
    <h2 class="currentPlanetHeader"></h2>
    <h2>Dodaj punkt</h2>
      <div class="xy-inputs">
  <div>
    <label>X (−90 do 90)</label>
    <input type="number" id="lat" step="1" min="-90" max="90" />
  </div>
  <div>
    <label>Y (−180 do 180)</label>
    <input type="number" id="lng" step="1" min="-180" max="180" />
  </div>
</div>

    <label>Nazwa punktu</label>
    <input type="text" id="name" />
    <label>Typ</label>
    <select id="type">
      <option>Zasób</option>
      <option>Obelisk</option>
      <option>Baza</option>
      <option>Ruiny</option>
      <option>Struktura</option>
      <option>Inne</option>
    </select>
    <label>Notatki</label>
    <textarea id="notes"></textarea>

    <button onclick="addPoint()">Dodaj punkt</button>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
    <h2>Skalowanie i pozycja globu</h2>
    <label>Skala punktów</label>
    <input type="range" id="pointScale" min="0.1" max="5" step="0.1" value="0.4" oninput="updatePointScale()" />
    <label>Oddal glob</label>
    <input type="range" id="globeScale" min="0.01" max="1" step="0.01" value="1" oninput="updateGlobeScale()" />
    <label>Przesuń glob</label>
    <input type="range" id="globeOffset" min="-500" max="500" step="1" value="0" oninput="updateGlobeOffset()" />
    <button onclick="resetGlobePosition()">Reset pozycji globu</button>
    
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
    <h2>Import/Eksport</h2>
    <button onclick="exportAtlas()">Eksport JSON</button>
    <input type="file" id="importFile" accept="application/json" onchange="importAtlas(event)" />
  </div>

  <!-- Zakładka PLANETY -->
  <div id="planety" class="tab-content">
    <h2 class="currentPlanetHeader"></h2>
    <h3>Dodaj nową planetę</h3>

    <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
  <input type="text" id="newPlanetName" placeholder="Nazwa nowej planety" oninput="checkNewPlanetInput()" />
  <button id="addPlanetBtn" onclick="addNewPlanet()" disabled>Dodaj nową planetę</button>
</div>

      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
    <h2>Tekstura planety</h2>
    <div class="texture-input">
      <input type="file" id="planetTextureInput" accept="image/*" hidden />
      <button onclick="document.getElementById('planetTextureInput').click()">Wybierz plik</button>
      <button onclick="setPlanetTextureFromInput()">Ustaw</button>
    </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
    <h2>Lista planet</h2>
    <div id="planetList"></div>
  </div>

  <!-- Zakładka PUNKTY -->
  <div id="punkty" class="tab-content">
    <h2 class="currentPlanetHeader"></h2>
    <label>Sortuj:</label>
    <select id="sortPoints" onchange="refreshPointsList()">
      <option value="nameAsc">Nazwa A–Z</option>
      <option value="nameDesc">Nazwa Z–A</option>
      <option value="type">Typ</option>
      <option value="newest">Najnowsze</option>
      <option value="oldest">Najstarsze</option>
    </select>
    <ul id="pointsList"></ul>
  </div>

  <!-- Zakładka DETALE PLANETY -->
<div id="detale" class="tab-content">
  <h2 class="currentPlanetHeader"></h2>
  <label>Galaktyka</label><input type="text" id="detailGalaxy" />
  <label>Region</label><input type="text" id="detailRegion" />
  <label>Układ gwiazdowy</label><input type="text" id="detailSystem" />

  <label>Biom</label>
  <select id="detailBiome">
    <option value="">-- wybierz --</option>
    <option>Bujna</option>
    <option>Jałowa</option>
    <option>Martwa</option>
    <option>Egzotyczna</option>
    <option>Mega Egzotyczna</option>
    <option>Spalona</option>
    <option>Zamrożona</option>
    <option>Toksyczna</option>
    <option>Napromieniowana</option>
    <option>Bagno</option>
    <option>Wulkaniczna</option>
    <option>Gazowy Gigant</option>
  </select>

  <label>Pogoda</label>
<select id="detailWeather">
  <option value="">-- wybierz --</option>
<option>Brak atmosfery</option>
    <option>Słonecznie</option>
    <option>Chłodno</option>
    <option>Mroźno</option>
    <option>Ciepło</option>
    <option>Gorąco</option>
    <option>Wilgotno</option>
    <option>Deszczowo</option>
    <option>Burzowo</option>
    <option>Radioaktywne</option>
    <option>Toksyczne</option>
    <option>Kwasyczne</option>
    <option>Pyłowe</option>
    <option>Wulkaniczne</option>
    <option>Burze piaskowe</option>
    <option>Tornada</option>
    <option>Meteoryty</option>
    <option>Burze ogniste</option>
    <option>Wysokie ciśnienie</option>
    <option>Niskie ciśnienie</option>
    <option>Burze magnetyczne</option>
    <option>Burze elektryczne</option>
</select>

  <label>Strażnicy</label>
  <select id="detailSentinels">
    <option value="">-- wybierz --</option>
    <option>Pasywne</option>
    <option>Brak</option>
    <option>Zrelaksowane</option>
    <option>Ograniczone</option>
    <option>Niskie</option>
    <option>Niskie bezpieczeństwo</option>
    <option>Minimalne</option>
    <option>Aktywne</option>
    <option>Średnie</option>
    <option>Standardowe</option>
    <option>Typowe</option>
    <option>Uważne</option>
  </select>

  <label>Flora</label>
  <select id="detailFlora">
    <option value="">-- wybierz --</option>
    <option>Brak</option>
    <option>Sporadyczna</option>
    <option>Skąpa</option>
    <option>Średnia</option>
    <option>Obfita</option>
    <option>Ekstremalna</option>
  </select>

  <label>Fauna</label>
  <select id="detailFauna">
    <option value="">-- wybierz --</option>
    <option>Brak</option>
    <option>Sporadyczna</option>
    <option>Skąpa</option>
    <option>Średnia</option>
    <option>Obfita</option>
    <option>Ekstremalna</option>
  </select>

  <label>Odkryty przez</label><input type="text" id="detailDiscovered" />

  <label>Tryb gry</label>
  <select id="detailMode">
    <option value="">-- wybierz --</option>
    <option>Normalny</option>
    <option>Kreatywny</option>
    <option>Survival</option>
    <option>Permadeath</option>
  </select>

  <label>Zaktualizowano</label><input type="text" id="detailUpdated" />
  <label>Koordynaty</label><input type="text" id="detailCoords" />
  <!-- Przycisk przejdź do NMS Portals -->
<button onclick="window.open('https://nmsportals.github.io', '_blank')" 
        style="margin-top:0.5rem; background:#1976d2; color:white; padding:0.5rem; border:none; border-radius:4px; cursor:pointer;">
  Przejdź do NMS Portals
</button>
  
  <label>Notatki planety</label><textarea id="detailNotes"></textarea>
  <button onclick="savePlanetDetails()">Zapisz opis planety</button>
</div>
</div>

<div id="globeViz">
 </div>

<script>
let atlas = JSON.parse(localStorage.getItem("atlas") || "{}");
let planetTextures = JSON.parse(localStorage.getItem("planetTextures") || "{}");
let planetDetails = JSON.parse(localStorage.getItem("planetDetails") || "{}"); 
let planetColors = JSON.parse(localStorage.getItem("planetColors") || "{}"); // fallback color
let currentPlanet = null;
let pointScale = parseFloat(document.getElementById("pointScale").value);
let editIndex = null;

// ---------------------- GLOB ----------------------
const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null)
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
  .pointLat("lat")
  .pointLng("lng")
  .pointLabel(d => `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`)
  .pointColor(d=>{
    switch(d.type){
      case "Zasób": return d.extracted?"gray":"gold";
      case "Obelisk": return d.visited?"green":"orange";
      case "Baza": return "blue";
      case "Ruiny": return "brown";
      case "Struktura": return "purple";
      case "Inne": return "pink";
      case "Pole": return "red";
      default: return "red";
    }
  })
  .pointRadius(() => pointScale)
  .htmlElementsData([])
  .htmlElement(d=>{
    if(d.type==="Pole"){
      const el=document.createElement("div");
      el.style.color="white";
      el.style.fontSize="20px";
      el.style.fontWeight="bold";
      el.style.textShadow="0 0 4px black";
      el.textContent=d.name==="Biegun Północny"?"N":"S";
      return el;
    }
  });

globe.showGraticules(true).graticuleLineWidth(0.5);

// ---------------------- FUNKCJE TEKSTUR ----------------------
function getBasePath() {
  return window.location.origin + window.location.pathname.replace(/\/[^/]*$/, "/");
}

// Ustawienie tekstury z inputu pliku
function setPlanetTextureFromInput() {
  const input = document.getElementById("planetTextureInput");
  if(!input.files[0]) return;

  if(!currentPlanet) { alert("Wybierz planetę!"); return; }

  const fileName = input.files[0].name;
  planetTextures[currentPlanet] = getBasePath() + "textures/" + fileName;

  applyPlanetTexture(currentPlanet);
  saveAtlas();
}

// Zastosowanie tekstury lub koloru do globu
function applyPlanetTexture(planet) {
  if(!planet) return;

  if(planetTextures[planet]) {
    globe.globeImageUrl(planetTextures[planet]);
    return;
  }

  if(planetColors[planet]) {
    globe.globeImageUrl(null);
    globe.globeMaterial().color.set(planetColors[planet]);
    return;
  }

  globe.globeImageUrl(null);
  globe.globeMaterial().color.set('#000000');
}

// ---------------------- ZAPIS / ODCZYT ----------------------
function saveAtlas(){
  localStorage.setItem("atlas", JSON.stringify(atlas));
  localStorage.setItem("planetTextures", JSON.stringify(planetTextures));
  localStorage.setItem("planetDetails", JSON.stringify(planetDetails));
  localStorage.setItem("planetColors", JSON.stringify(planetColors));
}

// ---------------------- PLANETY ----------------------
function addNewPlanet() {
  const input = document.getElementById("newPlanetName");
  const name = input.value.trim();
  if (!name) return;

  if (atlas[name]) { alert("Planeta już istnieje!"); return; }

  atlas[name] = [];
  addPoles(name);

  planetDetails[name] = { galaxy:"", region:"", system:"", biome:"", weather:"", sentinels:"", flora:"", fauna:"", discovered:"", mode:"", updated:"", coords:"", notes:"" };

  // fallback color na losowy (jeśli nie dodano tekstury)
  planetColors[name] = "#"+Math.floor(Math.random()*16777215).toString(16);

  currentPlanet = name;
  saveAtlas();
  refreshPlanetList();
  refreshPointsList();
  applyPlanetTexture(name);
  updateCurrentPlanetHeader();
  input.value = "";
  alert(`Dodano planetę: ${name}`);
}

// ---------------------- IMPORT / EXPORT ----------------------
function exportAtlas(){
  const blob = new Blob([JSON.stringify({atlas,planetTextures,planetDetails,planetColors},null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      if(data.atlas) atlas = data.atlas;
      if(data.planetTextures) planetTextures = data.planetTextures;
      if(data.planetDetails) planetDetails = data.planetDetails;
      if(data.planetColors) planetColors = data.planetColors;

      const planets = Object.keys(atlas);
      currentPlanet = planets[0] || null;
      if(currentPlanet) applyPlanetTexture(currentPlanet);

      updateCurrentPlanetHeader();
      saveAtlas();
      refreshPlanetList();
      refreshPointsList();
      refreshGlobePoints();
      alert("Import zakończony!");
    } catch(err){ alert("Błąd importu JSON"); }
  };
  reader.readAsText(file);
}


</script>
</body>
</html>
