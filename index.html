<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Atlas Planetarny</title>
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
      overflow: hidden;
      background: #0d1b2a; /* ciemnogranatowe tło */
      color: #e0e6ed;
    }
    #form {
      flex: 0 0 600px;
      padding: 1rem;
      background: #1b263b;
      overflow-y: auto;
      box-sizing: border-box;
    }
    #globeViz {
      flex: 1;
    }
    h2 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: #f0f4f8;
    }
    label {
      font-weight: bold;
      margin-top: 0.5rem;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      margin: 0.3rem 0;
      padding: 0.4rem;
      box-sizing: border-box;
      border: none;
      border-radius: 4px;
    }
    input, select, textarea {
      background: #24344d;
      color: #f0f4f8;
    }
    button {
      background: #1976d2;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #1565c0;
    }
    .texture-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .texture-input button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #texturePreview {
      margin-top: 0.5rem;
      max-width: 100%;
      border-radius: 6px;
      display: none;
    }
    .grid-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .grid-control input[type="number"] {
      flex: 0 0 70px;
    }
    .grid-control input[type="range"] {
      flex: 1;
    }
  </style>
</head>
<body>
  <div id="form">
    <h2>Dodaj punkt</h2>
    <label>Planeta</label>
    <input type="text" id="planet" placeholder="Nazwa planety" />
    <label>Szerokość</label>
    <input type="number" id="lat" step="0.0001" />
    <label>Długość</label>
    <input type="number" id="lng" step="0.0001" />
    <label>Nazwa punktu</label>
    <input type="text" id="name" />
    <label>Typ</label>
    <select id="type">
      <option>Resource</option>
      <option>Obelisk</option>
      <option>Other</option>
    </select>
    <label>Notatki</label>
    <textarea id="notes"></textarea>
    <button onclick="addPoint()">Dodaj punkt</button>

    <h2>Planety</h2>
    <div id="planetList"></div>

    <h2>Tekstura planety</h2>
    <div class="texture-input">
      <input type="file" id="planetTextureInput" accept="image/*" hidden />
      <button onclick="document.getElementById('planetTextureInput').click()">Wybierz plik</button>
      <button onclick="setPlanetTextureFromInput()">Ustaw</button>
    </div>
    <img id="texturePreview" />

    <h2>Siatka współrzędnych</h2>
    <div class="grid-control">
      <input type="number" id="gridScale" value="15" min="1" max="90" step="1" oninput="syncGridInputs('number')" />
      <input type="range" id="gridScaleRange" value="15" min="1" max="90" step="1" oninput="syncGridInputs('range')" />
    </div>
  </div>

  <div id="globeViz"></div>

  <script>
    let atlas = JSON.parse(localStorage.getItem("atlas") || "{}");
    let currentPlanet = null;
    let planetTextures = JSON.parse(localStorage.getItem("planetTextures") || "{}");

    const globe = Globe()(document.getElementById("globeViz"))
      .globeImageUrl(null)
      .pointLat("lat")
      .pointLng("lng")
      .pointLabel((d) =>
        `<b>${d.name || ""}</b><br>Typ: ${d.type}<br>Lat: ${d.lat.toFixed(2)}°, Lng: ${d.lng.toFixed(2)}°<br>${d.notes || ""}`
      )
      .pointColor((d) =>
        d.type === "Resource"
          ? "yellow"
          : d.type === "Obelisk"
          ? "cyan"
          : d.type === "Pole"
          ? "white"
          : "red"
      )
      .pointRadius(0.8)
      .htmlElementsData([])
      .htmlElement((d) => {
        const el = document.createElement("div");
        if (d.type === "Pole") {
          el.style.color = "white";
          el.style.fontSize = "20px";
          el.style.fontWeight = "bold";
          el.style.textShadow = "0 0 4px black";
          el.textContent =
            d.name === "Biegun Północny"
              ? "N"
              : d.name === "Biegun Południowy"
              ? "S"
              : "";
        }
        return el;
      });

    // Siatka współrzędnych
    globe.showGraticules(true).graticuleLineWidth(0.8);
    function updateGrid() {
      const scale = parseInt(document.getElementById("gridScale").value);
      if (isNaN(scale) || scale < 1) return;
      globe.graticuleStep([scale, scale]);
    }
    function syncGridInputs(source) {
      const num = document.getElementById("gridScale");
      const range = document.getElementById("gridScaleRange");
      if (source === "number") {
        range.value = num.value;
      } else {
        num.value = range.value;
      }
      updateGrid();
    }
    updateGrid();

    function saveAtlas() {
      localStorage.setItem("atlas", JSON.stringify(atlas));
      localStorage.setItem("planetTextures", JSON.stringify(planetTextures));
    }

    function addPoles(planet) {
      if (!atlas[planet]) atlas[planet] = [];
      if (!atlas[planet].some((p) => p.type === "Pole")) {
        atlas[planet].push(
          { lat: 90, lng: 0, name: "Biegun Północny", type: "Pole" },
          { lat: -90, lng: 0, name: "Biegun Południowy", type: "Pole" }
        );
      }
    }

    function refreshPlanetList() {
      const list = document.getElementById("planetList");
      list.innerHTML = "";
      Object.keys(atlas).forEach((p) => {
        const btn = document.createElement("button");
        btn.textContent = p;
        btn.style.width = "100%";
        btn.style.margin = "0.2rem 0";
        btn.onclick = () => {
          currentPlanet = p;
          addPoles(p);
          globe.pointsData(atlas[p]);
          globe.htmlElementsData(atlas[p].filter((pt) => pt.type === "Pole"));
          setPlanetTexture(p);
          if (planetTextures[p]) {
            document.getElementById("texturePreview").src = planetTextures[p];
            document.getElementById("texturePreview").style.display = "block";
          } else {
            document.getElementById("texturePreview").style.display = "none";
          }
        };
        list.appendChild(btn);
      });
    }

    function addPoint() {
      const planet = document.getElementById("planet").value.trim();
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const name = document.getElementById("name").value.trim();
      const type = document.getElementById("type").value;
      const notes = document.getElementById("notes").value.trim();

      if (!planet || isNaN(lat) || isNaN(lng)) {
        alert("Uzupełnij planetę, szerokość i długość!");
        return;
      }

      if (!atlas[planet]) atlas[planet] = [];
      const point = { planet, lat, lng, name, type, notes };
      if (type === "Resource") point.extracted = false;
      if (type === "Obelisk") point.visited = false;
      atlas[planet].push(point);

      saveAtlas();
      currentPlanet = planet;
      refreshPlanetList();

      document.getElementById("lat").value = "";
      document.getElementById("lng").value = "";
      document.getElementById("name").value = "";
      document.getElementById("notes").value = "";
    }

    function setPlanetTexture(planet) {
      if (planetTextures[planet]) {
        globe.globeImageUrl(planetTextures[planet]);
      } else {
        globe.globeImageUrl(null);
      }
    }

    function setPlanetTextureFromInput() {
      const input = document.getElementById("planetTextureInput");
      if (!input.files[0] || !currentPlanet) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        planetTextures[currentPlanet] = e.target.result;
        setPlanetTexture(currentPlanet);
        document.getElementById("texturePreview").src = e.target.result;
        document.getElementById("texturePreview").style.display = "block";
        saveAtlas();
      };
      reader.readAsDataURL(input.files[0]);
    }

    refreshPlanetList();
  </script>
</body>
</html>
